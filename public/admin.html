<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice Automation - Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .loader { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold mb-2">Invoice Automation</h2>
      <p class="text-gray-600 mb-6">Sign in to access the admin dashboard.</p>

      <form id="loginForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input type="email" id="loginEmail" required placeholder="admin@company.com"
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
          <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div id="loginError" class="hidden text-red-600 text-sm"></div>
        <button type="submit" id="loginBtn" class="w-full bg-blue-600 text-white rounded-lg px-4 py-2 font-medium hover:bg-blue-700">
          Sign In
        </button>
      </form>

      <div class="mt-6 pt-6 border-t">
        <p class="text-xs text-gray-500 text-center">Powered by Supabase Auth</p>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-gray-900">Invoice Automation</h1>
        <div class="flex items-center gap-4">
          <span id="userEmail" class="text-sm text-gray-600"></span>
          <span class="text-sm text-green-600">‚óè Connected</span>
          <button onclick="logout()" class="text-red-500 hover:text-red-700 text-sm">Logout</button>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white border-b">
      <div class="max-w-7xl mx-auto px-4">
        <div class="flex gap-8">
          <button onclick="showTab('dashboard')" class="tab-btn py-4 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="dashboard">Dashboard</button>
          <button onclick="showTab('customers')" class="tab-btn py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="customers">Customers</button>
          <button onclick="showTab('add-customer')" class="tab-btn py-4 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="add-customer">Add Customer</button>
        </div>
      </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content max-w-7xl mx-auto px-4 py-8">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500">Total Customers</p>
          <p id="stat-customers" class="text-3xl font-bold text-gray-900">-</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500">Invoices Today</p>
          <p id="stat-today" class="text-3xl font-bold text-blue-600">-</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500">Pending Approval</p>
          <p id="stat-pending" class="text-3xl font-bold text-yellow-600">-</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-sm text-gray-500">Total Processed</p>
          <p id="stat-total" class="text-3xl font-bold text-green-600">-</p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b">
          <h2 class="text-lg font-semibold">Recent Invoices</h2>
        </div>
        <div id="recent-invoices" class="p-6">
          <p class="text-gray-500">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Customers Tab -->
    <div id="customers-tab" class="tab-content hidden max-w-7xl mx-auto px-4 py-8">
      <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b flex justify-between items-center">
          <h2 class="text-lg font-semibold">All Customers</h2>
          <button onclick="loadCustomers()" class="text-blue-600 hover:text-blue-800">Refresh</button>
        </div>
        <div id="customers-list" class="p-6">
          <p class="text-gray-500">Loading...</p>
        </div>
      </div>
    </div>

    <!-- Add Customer Tab -->
    <div id="add-customer-tab" class="tab-content hidden max-w-7xl mx-auto px-4 py-8">
      <div class="max-w-2xl">
        <div class="bg-white rounded-lg shadow">
          <div class="px-6 py-4 border-b">
            <h2 class="text-lg font-semibold">Add New Customer</h2>
          </div>
          <form id="add-customer-form" class="p-6 space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
              <input type="text" name="name" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
              <input type="email" name="email" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Accounting Platform</label>
              <select name="accounting_platform" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                <option value="">Select...</option>
                <option value="xero">Xero</option>
                <option value="quickbooks">QuickBooks</option>
                <option value="freshbooks">FreshBooks</option>
                <option value="wave">Wave</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Slack Webhook URL</label>
              <input type="url" name="slack_webhook_url" placeholder="https://hooks.slack.com/services/..." class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
              <p class="text-xs text-gray-500 mt-1">For invoice approval notifications</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Slack Channel</label>
              <input type="text" name="slack_channel" placeholder="#invoices" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white rounded-lg px-4 py-3 font-medium hover:bg-blue-700">
              Create Customer
            </button>
          </form>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-6">
          <h3 class="text-lg font-semibold text-green-800 mb-2">Customer Created!</h3>
          <div class="space-y-2 text-sm">
            <p><strong>Customer ID:</strong> <code id="new-customer-id" class="bg-green-100 px-2 py-1 rounded"></code></p>
            <p><strong>API Key:</strong> <code id="new-api-key" class="bg-green-100 px-2 py-1 rounded break-all"></code></p>
          </div>
          <p class="text-red-600 font-medium mt-4">Save the API key now - it won't be shown again!</p>
          <button onclick="copyApiKey()" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            Copy API Key
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase configuration - UPDATE THIS WITH YOUR PROJECT URL
    const SUPABASE_URL = 'https://tcgptxbqqyxmvsaqiblc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZ3B0eGJxcXl4bXZzYXFpYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTQwODksImV4cCI6MjA4NTk3MDA4OX0.nyTEkolz8sft-qFoHpwsLl4F4JkIEW7A3c8aPGftprc';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let session = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check for existing session
      const { data: { session: existingSession } } = await supabase.auth.getSession();

      if (existingSession) {
        session = existingSession;
        showApp();
      }

      // Listen for auth changes
      supabase.auth.onAuthStateChange((event, newSession) => {
        session = newSession;
        if (event === 'SIGNED_IN') {
          showApp();
        } else if (event === 'SIGNED_OUT') {
          showLogin();
        }
      });
    });

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const btn = document.getElementById('loginBtn');

      btn.disabled = true;
      btn.textContent = 'Signing in...';
      errorEl.classList.add('hidden');

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
        btn.disabled = false;
        btn.textContent = 'Sign In';
        return;
      }

      session = data.session;
      showApp();
    });

    function showApp() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('userEmail').textContent = session?.user?.email || '';
      loadDashboard();
    }

    function showLogin() {
      document.getElementById('loginModal').classList.remove('hidden');
      document.getElementById('app').classList.add('hidden');
    }

    async function logout() {
      await supabase.auth.signOut();
      session = null;
      showLogin();
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('border-blue-500', 'text-blue-600');
        el.classList.add('border-transparent', 'text-gray-500');
      });

      document.getElementById(`${tabName}-tab`).classList.remove('hidden');
      document.querySelector(`[data-tab="${tabName}"]`).classList.remove('border-transparent', 'text-gray-500');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');

      if (tabName === 'customers') loadCustomers();
      if (tabName === 'dashboard') loadDashboard();
    }

    async function apiCall(endpoint, method = 'GET', body = null) {
      if (!session) {
        showLogin();
        throw new Error('Not authenticated');
      }

      const options = {
        method,
        headers: {
          'Authorization': `Bearer ${session.access_token}`,
          'apikey': SUPABASE_ANON_KEY,
          'Content-Type': 'application/json',
        },
      };
      if (body) options.body = JSON.stringify(body);

      const response = await fetch(`${SUPABASE_URL}/functions/v1/${endpoint}`, options);

      if (response.status === 401) {
        await logout();
        throw new Error('Session expired');
      }

      return response.json();
    }

    async function loadDashboard() {
      try {
        const data = await apiCall('admin-get-dashboard');

        if (data.error) {
          document.getElementById('recent-invoices').innerHTML = `<p class="text-red-500">Error: ${data.error}</p>`;
          return;
        }

        document.getElementById('stat-customers').textContent = data.stats?.total_customers || 0;
        document.getElementById('stat-today').textContent = data.stats?.invoices_today || 0;
        document.getElementById('stat-pending').textContent = data.stats?.pending_approval || 0;
        document.getElementById('stat-total').textContent = data.stats?.total_invoices || 0;

        const invoicesHtml = data.recent_invoices?.length > 0
          ? `<table class="w-full">
              <thead>
                <tr class="text-left text-sm text-gray-500">
                  <th class="pb-2">Invoice #</th>
                  <th class="pb-2">Customer</th>
                  <th class="pb-2">Amount</th>
                  <th class="pb-2">Status</th>
                  <th class="pb-2">Date</th>
                </tr>
              </thead>
              <tbody>
                ${data.recent_invoices.map(inv => `
                  <tr class="border-t">
                    <td class="py-3">${inv.invoice_number || '-'}</td>
                    <td class="py-3">${inv.customer_name}</td>
                    <td class="py-3">${inv.currency} ${inv.total?.toFixed(2) || '-'}</td>
                    <td class="py-3"><span class="px-2 py-1 rounded text-xs ${getStatusClass(inv.status)}">${inv.status}</span></td>
                    <td class="py-3 text-sm text-gray-500">${new Date(inv.created_at).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`
          : '<p class="text-gray-500">No invoices yet</p>';

        document.getElementById('recent-invoices').innerHTML = invoicesHtml;
      } catch (error) {
        console.error('Failed to load dashboard:', error);
        document.getElementById('recent-invoices').innerHTML = '<p class="text-red-500">Failed to load data</p>';
      }
    }

    async function loadCustomers() {
      try {
        const data = await apiCall('admin-list-customers');

        if (data.error) {
          document.getElementById('customers-list').innerHTML = `<p class="text-red-500">Error: ${data.error}</p>`;
          return;
        }

        const html = data.customers?.length > 0
          ? `<table class="w-full">
              <thead>
                <tr class="text-left text-sm text-gray-500">
                  <th class="pb-2">Company</th>
                  <th class="pb-2">Email</th>
                  <th class="pb-2">Platform</th>
                  <th class="pb-2">Invoices</th>
                  <th class="pb-2">Status</th>
                </tr>
              </thead>
              <tbody>
                ${data.customers.map(c => `
                  <tr class="border-t">
                    <td class="py-3 font-medium">${c.name}</td>
                    <td class="py-3">${c.email}</td>
                    <td class="py-3">${c.accounting_platform || '-'}</td>
                    <td class="py-3">${c.invoice_count}</td>
                    <td class="py-3">
                      <span class="px-2 py-1 rounded text-xs ${c.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                        ${c.is_active ? 'Active' : 'Inactive'}
                      </span>
                      ${c.has_slack ? '<span class="ml-1 text-purple-600">üì®</span>' : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>`
          : '<p class="text-gray-500">No customers yet. Add your first customer to get started!</p>';

        document.getElementById('customers-list').innerHTML = html;
      } catch (error) {
        console.error('Failed to load customers:', error);
        document.getElementById('customers-list').innerHTML = '<p class="text-red-500">Failed to load customers</p>';
      }
    }

    document.getElementById('add-customer-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Creating...';

      try {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Clean empty values
        Object.keys(data).forEach(key => {
          if (data[key] === '') data[key] = null;
        });

        const result = await apiCall('admin-create-customer', 'POST', data);

        if (result.error) {
          alert('Error: ' + result.error);
          return;
        }

        document.getElementById('new-customer-id').textContent = result.customer.id;
        document.getElementById('new-api-key').textContent = result.api_key;
        document.getElementById('success-message').classList.remove('hidden');
        form.reset();
      } catch (error) {
        alert('Failed to create customer: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Create Customer';
      }
    });

    function copyApiKey() {
      const apiKey = document.getElementById('new-api-key').textContent;
      navigator.clipboard.writeText(apiKey);
      alert('API key copied to clipboard!');
    }

    function getStatusClass(status) {
      const classes = {
        pending: 'bg-yellow-100 text-yellow-800',
        approved: 'bg-blue-100 text-blue-800',
        synced: 'bg-green-100 text-green-800',
        flagged: 'bg-red-100 text-red-800',
        error: 'bg-red-100 text-red-800',
      };
      return classes[status] || 'bg-gray-100 text-gray-800';
    }
  </script>
</body>
</html>
