---
export const prerender = false;
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Dashboard">
  <!-- ===== Failed Processing Alert Banner ===== -->
  <div id="failed-banner" class="alert alert-error mb-4 hidden">
    <span>⚠ <strong id="failed-count">0</strong> invoices failed processing.</span>
  </div>

  <!-- ===== Summary Stats Cards (4 cards) ===== -->
  <div id="stats-section" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-2">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <p class="text-xs uppercase tracking-wide opacity-60 font-semibold">Needs Review</p>
        <p id="stat-needs-review" class="text-2xl font-bold mt-1 text-warning">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <p class="text-xs uppercase tracking-wide opacity-60 font-semibold">Approved</p>
        <p id="stat-approved" class="text-2xl font-bold mt-1 text-success">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <p class="text-xs uppercase tracking-wide opacity-60 font-semibold">Amount Awaiting Approval</p>
        <p id="stat-amount-awaiting" class="text-2xl font-bold mt-1 text-info">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <p class="text-xs uppercase tracking-wide opacity-60 font-semibold">Amount Approved</p>
        <p id="stat-amount-approved" class="text-2xl font-bold mt-1 text-success">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
  </div>

  <!-- ===== All-time total line ===== -->
  <p id="stat-total-line" class="text-sm opacity-50 mt-2 mb-4 text-center"></p>

  <!-- ===== Time Range Preset Buttons ===== -->
  <div class="flex gap-2 mb-4" id="time-range-buttons">
    <button class="btn btn-sm" data-range="today">Today</button>
    <button class="btn btn-sm" data-range="week">This Week</button>
    <button class="btn btn-sm" data-range="month">This Month</button>
    <button class="btn btn-sm btn-active" data-range="all">All Time</button>
  </div>

  <!-- ===== Filters & Search Bar ===== -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body p-4">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
        <!-- Search -->
        <div class="form-control w-full sm:w-auto sm:flex-1">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Search</span>
          </label>
          <input
            id="filter-search"
            type="text"
            placeholder="Search vendor or invoice #..."
            class="input input-bordered input-sm w-full"
          />
        </div>

        <!-- Status Filter -->
        <div class="form-control w-full sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Status</span>
          </label>
          <select id="filter-status" class="select select-bordered select-sm w-full">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="flagged">Flagged</option>
            <option value="rejected">Rejected</option>
            <option value="synced">Synced</option>
            <option value="error">Error</option>
          </select>
        </div>

        <!-- Sort -->
        <div class="form-control w-full sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Sort By</span>
          </label>
          <select id="filter-sort" class="select select-bordered select-sm w-full">
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
            <option value="amount-desc">Amount (High-Low)</option>
            <option value="amount-asc">Amount (Low-High)</option>
          </select>
        </div>

        <!-- Per-page limit -->
        <div class="form-control w-full sm:w-32">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Per Page</span>
          </label>
          <select id="filter-limit" class="select select-bordered select-sm w-full">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <!-- Vendor Group Toggle -->
        <button id="toggle-vendor-group" class="btn btn-sm btn-outline">Group by Vendor</button>

        <!-- Export CSV -->
        <button id="export-csv" class="btn btn-sm btn-outline">Export CSV</button>
      </div>
    </div>
  </div>

  <!-- ===== Invoice Table ===== -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-0">
      <!-- Loading state -->
      <div id="table-loading" class="flex flex-col items-center justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-3 text-sm opacity-60">Loading invoices...</p>
      </div>

      <!-- Error state -->
      <div id="table-error" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-error mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <p class="font-semibold text-error">Failed to load invoices</p>
        <p id="table-error-message" class="text-sm opacity-60 mt-1"></p>
        <button id="retry-btn" class="btn btn-sm btn-primary mt-4 no-underline">Retry</button>
      </div>

      <!-- Empty state -->
      <div id="table-empty" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-30 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="font-semibold">No invoices found</p>
        <p class="text-sm opacity-60 mt-1">Try adjusting your filters or search term.</p>
      </div>

      <!-- Table -->
      <div id="table-container" class="hidden overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr class="border-b border-base-200">
              <th class="w-10"><input type="checkbox" id="select-all" class="checkbox checkbox-sm" /></th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Invoice #</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Vendor</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Amount</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden sm:table-cell">Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden md:table-cell">Due Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Status</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden lg:table-cell">Confidence</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="invoice-table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Bulk Actions Bar ===== -->
  <div id="bulk-actions" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-base-300 rounded-box shadow-xl p-3 flex items-center gap-3 z-50">
    <span id="bulk-count">0 selected</span>
    <button id="bulk-approve" class="btn btn-sm btn-success">Approve Selected</button>
    <button id="bulk-reject" class="btn btn-sm btn-error">Reject Selected</button>
    <button id="bulk-cancel" class="btn btn-sm btn-ghost">Cancel</button>
  </div>

  <!-- ===== Pagination ===== -->
  <div id="pagination-section" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p id="pagination-info" class="text-sm opacity-60"></p>
    <div class="join">
      <button id="page-prev" class="join-item btn btn-sm no-underline" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Prev
      </button>
      <div id="page-numbers" class="join-item flex">
        <!-- Page buttons injected by JS -->
      </div>
      <button id="page-next" class="join-item btn btn-sm no-underline">
        Next
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- ===== Activity Feed ===== -->
  <details class="collapse collapse-arrow bg-base-100 shadow-sm mt-6">
    <summary class="collapse-title text-sm font-semibold">Recent Activity</summary>
    <div class="collapse-content" id="activity-feed">
      <p class="text-sm opacity-50 py-2">Activity feed coming soon.</p>
    </div>
  </details>
</DashboardLayout>

<style>
  /* Make table rows clickable-looking */
  #invoice-table-body tr {
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #invoice-table-body tr:hover {
    background-color: oklch(var(--b2));
  }
  /* Vendor group header rows should not look clickable */
  #invoice-table-body tr.vendor-group-header {
    cursor: default;
  }
  /* Remove default anchor underline from rows */
  #invoice-table-body tr a {
    text-decoration: none;
  }
  /* Smooth fade-in for content */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in {
    animation: fadeIn 0.3s ease forwards;
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  // ─── Constants & Config ───────────────────────────────────────────
  const FUNCTIONS_URL = 'https://tcgptxbqqyxmvsaqiblc.supabase.co/functions/v1';
  const API_BASE = `${FUNCTIONS_URL}/admin-get-dashboard`;
  const APPROVE_URL = `${FUNCTIONS_URL}/approve-invoice`;

  // ─── State ────────────────────────────────────────────────────────
  let currentPage = 1;
  let currentLimit = 25;
  let currentStatus = '';
  let currentSort = 'date-desc';
  let currentSearch = '';
  let currentDateFrom = '';
  let allInvoices: any[] = [];
  let selectedInvoices: Set<string> = new Set();
  let vendorGroupMode = false;
  let searchDebounceTimer: ReturnType<typeof setTimeout> | null = null;

  // ─── DOM Elements ─────────────────────────────────────────────────
  const failedBanner = document.getElementById('failed-banner')!;
  const failedCount = document.getElementById('failed-count')!;

  const statNeedsReview = document.getElementById('stat-needs-review')!;
  const statApproved = document.getElementById('stat-approved')!;
  const statAmountAwaiting = document.getElementById('stat-amount-awaiting')!;
  const statAmountApproved = document.getElementById('stat-amount-approved')!;
  const statTotalLine = document.getElementById('stat-total-line')!;

  const filterSearch = document.getElementById('filter-search') as HTMLInputElement;
  const filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
  const filterSort = document.getElementById('filter-sort') as HTMLSelectElement;
  const filterLimit = document.getElementById('filter-limit') as HTMLSelectElement;

  const tableLoading = document.getElementById('table-loading')!;
  const tableError = document.getElementById('table-error')!;
  const tableErrorMessage = document.getElementById('table-error-message')!;
  const tableEmpty = document.getElementById('table-empty')!;
  const tableContainer = document.getElementById('table-container')!;
  const tableBody = document.getElementById('invoice-table-body')!;
  const retryBtn = document.getElementById('retry-btn')!;

  const paginationSection = document.getElementById('pagination-section')!;
  const paginationInfo = document.getElementById('pagination-info')!;
  const pageNumbers = document.getElementById('page-numbers')!;
  const pagePrev = document.getElementById('page-prev') as HTMLButtonElement;
  const pageNext = document.getElementById('page-next') as HTMLButtonElement;

  const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
  const bulkActions = document.getElementById('bulk-actions')!;
  const bulkCountEl = document.getElementById('bulk-count')!;
  const bulkApproveBtn = document.getElementById('bulk-approve')!;
  const bulkRejectBtn = document.getElementById('bulk-reject')!;
  const bulkCancelBtn = document.getElementById('bulk-cancel')!;

  const exportCsvBtn = document.getElementById('export-csv')!;
  const toggleVendorGroupBtn = document.getElementById('toggle-vendor-group')!;

  const timeRangeButtons = document.getElementById('time-range-buttons')!;

  // ─── Formatters ───────────────────────────────────────────────────
  const currencyFormatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  const dateFormatter = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });

  function formatDate(dateStr: string | null): string {
    if (!dateStr) return '--';
    try {
      return dateFormatter.format(new Date(dateStr));
    } catch {
      return dateStr;
    }
  }

  function formatCurrency(amount: number | null | undefined): string {
    if (amount == null) return '--';
    return currencyFormatter.format(amount);
  }

  function formatConfidence(confidence: number | null | undefined): { text: string; class: string } {
    if (confidence == null) return { text: '--', class: 'opacity-40' };
    const pct = Math.round(confidence * 100);
    if (pct >= 90) return { text: `${pct}%`, class: 'text-success font-semibold' };
    if (pct >= 70) return { text: `${pct}%`, class: 'text-warning font-semibold' };
    return { text: `${pct}%`, class: 'text-error font-semibold' };
  }

  // ─── Status Badge ─────────────────────────────────────────────────
  function getStatusBadge(status: string): string {
    const map: Record<string, { class: string; label: string; icon?: string }> = {
      pending:  { class: 'badge-warning',  label: 'Pending' },
      approved: { class: 'badge-success',  label: 'Approved' },
      flagged:  { class: 'badge-error',    label: 'Flagged', icon: '\u26A0' },
      rejected: { class: 'badge-error',    label: 'Rejected' },
      synced:   { class: 'badge-info',     label: 'Synced' },
      error:    { class: 'badge-error',    label: 'Error' },
    };
    const info = map[status] || { class: 'badge-ghost', label: status };
    const iconHtml = info.icon ? `${info.icon} ` : '';
    return `<span class="badge badge-sm ${info.class} gap-1">${iconHtml}${info.label}</span>`;
  }

  // ─── Auth ──────────────────────────────────────────────────────────
  async function getAuthToken(): Promise<string | null> {
    const { data: { session } } = await supabase.auth.getSession();
    return session?.access_token ?? null;
  }

  // ─── API Fetch ────────────────────────────────────────────────────
  async function fetchDashboard(): Promise<any> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const params = new URLSearchParams();
    params.set('page', String(currentPage));
    params.set('limit', String(currentLimit));
    if (currentStatus) params.set('status', currentStatus);
    if (currentDateFrom) params.set('date_from', currentDateFrom);

    const url = `${API_BASE}?${params.toString()}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`API error ${response.status}: ${errorBody}`);
    }

    return response.json();
  }

  // ─── Approve/Reject API ───────────────────────────────────────────
  async function callApproveEndpoint(invoiceId: string, action: 'approve' | 'reject'): Promise<void> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const response = await fetch(APPROVE_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ invoice_id: invoiceId, action }),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`Approve API error ${response.status}: ${errorBody}`);
    }
  }

  // ─── Quick Action (single row approve/reject) ─────────────────────
  (window as any).quickAction = async function(invoiceId: string, action: 'approve' | 'reject') {
    try {
      await callApproveEndpoint(invoiceId, action);
      await loadDashboard();
    } catch (err: any) {
      console.error('Quick action error:', err);
      alert(`Failed to ${action} invoice: ${err.message}`);
    }
  };

  // ─── Client-Side Sorting & Filtering ──────────────────────────────
  function applyClientFilters(invoices: any[]): any[] {
    let filtered = [...invoices];

    // Search filter (client-side, across vendor_id and invoice_number)
    if (currentSearch.trim()) {
      const term = currentSearch.trim().toLowerCase();
      filtered = filtered.filter((inv) => {
        const invoiceNum = (inv.invoice_number || '').toLowerCase();
        const vendorId = (inv.vendor_id || '').toLowerCase();
        const vendorName = (inv.vendor_name || inv.vendors?.name || '').toLowerCase();
        return invoiceNum.includes(term) || vendorId.includes(term) || vendorName.includes(term);
      });
    }

    // Sort
    filtered.sort((a, b) => {
      switch (currentSort) {
        case 'date-asc':
          return new Date(a.invoice_date || 0).getTime() - new Date(b.invoice_date || 0).getTime();
        case 'date-desc':
          return new Date(b.invoice_date || 0).getTime() - new Date(a.invoice_date || 0).getTime();
        case 'amount-asc':
          return (a.total || 0) - (b.total || 0);
        case 'amount-desc':
          return (b.total || 0) - (a.total || 0);
        default:
          return 0;
      }
    });

    return filtered;
  }

  // ─── Checkbox / Bulk Selection Helpers ─────────────────────────────
  function updateBulkUI() {
    const count = selectedInvoices.size;
    if (count > 0) {
      bulkActions.classList.remove('hidden');
      bulkActions.style.display = 'flex';
      bulkCountEl.textContent = `${count} selected`;
    } else {
      bulkActions.classList.add('hidden');
      bulkActions.style.display = '';
    }
  }

  function bindCheckboxEvents() {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.addEventListener('change', (e) => {
        e.stopPropagation();
        const id = cb.dataset.invoiceId!;
        if (cb.checked) {
          selectedInvoices.add(id);
        } else {
          selectedInvoices.delete(id);
        }
        // Update select-all state
        selectAllCheckbox.checked = checkboxes.length > 0 && selectedInvoices.size === checkboxes.length;
        updateBulkUI();
      });
    });
  }

  // ─── Render Functions ─────────────────────────────────────────────
  function renderStats(summary: any) {
    statNeedsReview.textContent = String(summary.needs_review ?? 0);
    statApproved.textContent = String(summary.approved ?? 0);
    statAmountAwaiting.textContent = formatCurrency(summary.amount_awaiting_approval);
    statAmountApproved.textContent = formatCurrency(summary.amount_approved);

    // All-time total line
    const totalInvoices = summary.total_invoices ?? 0;
    statTotalLine.textContent = `${totalInvoices} invoice${totalInvoices !== 1 ? 's' : ''} processed all-time`;

    // Failed processing banner
    const failedProcessing = summary.failed_processing ?? 0;
    if (failedProcessing > 0) {
      failedCount.textContent = String(failedProcessing);
      failedBanner.classList.remove('hidden');
      failedBanner.style.display = '';
    } else {
      failedBanner.classList.add('hidden');
    }

    // Animate in
    document.getElementById('stats-section')?.classList.add('fade-in');
  }

  function buildInvoiceRow(inv: any): string {
    const conf = formatConfidence(inv.confidence);
    const vendorDisplay = inv.vendors?.name || inv.vendor_name || '--';
    const isPendingOrFlagged = inv.status === 'pending' || inv.status === 'flagged';
    const isChecked = selectedInvoices.has(inv.id) ? 'checked' : '';

    const actionsHtml = isPendingOrFlagged
      ? `<td class="flex gap-1">
           <button onclick="event.stopPropagation(); quickAction('${inv.id}', 'approve')" class="btn btn-xs btn-success btn-outline" title="Approve">\u2713</button>
           <button onclick="event.stopPropagation(); quickAction('${inv.id}', 'reject')" class="btn btn-xs btn-error btn-outline" title="Reject">\u2717</button>
         </td>`
      : `<td></td>`;

    return `
      <tr onclick="window.location.href='/invoice/${inv.id}'" class="border-b border-base-200/50 hover:bg-base-200/50 cursor-pointer transition-colors">
        <td onclick="event.stopPropagation()"><input type="checkbox" class="checkbox checkbox-sm row-checkbox" data-invoice-id="${inv.id}" ${isChecked} /></td>
        <td class="font-mono text-sm font-medium">${escapeHtml(inv.invoice_number || '--')}</td>
        <td class="max-w-[200px] truncate">${escapeHtml(vendorDisplay)}</td>
        <td class="font-mono font-medium">${formatCurrency(inv.total)}</td>
        <td class="hidden sm:table-cell text-sm">${formatDate(inv.invoice_date)}</td>
        <td class="hidden md:table-cell text-sm">${formatDate(inv.due_date)}</td>
        <td>${getStatusBadge(inv.status || 'pending')}</td>
        <td class="hidden lg:table-cell"><span class="${conf.class}">${conf.text}</span></td>
        ${actionsHtml}
      </tr>
    `;
  }

  function renderTable(invoices: any[]) {
    const filtered = applyClientFilters(invoices);

    // Show/hide states
    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';

    if (filtered.length === 0) {
      tableEmpty.classList.remove('hidden');
      tableEmpty.style.display = 'flex';
      tableContainer.classList.add('hidden');
      return;
    }

    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.remove('hidden');
    tableContainer.classList.add('fade-in');

    if (vendorGroupMode) {
      renderVendorGroupedTable(filtered);
    } else {
      tableBody.innerHTML = filtered.map((inv) => buildInvoiceRow(inv)).join('');
    }

    bindCheckboxEvents();
    updateBulkUI();
  }

  function renderVendorGroupedTable(invoices: any[]) {
    // Group by vendor
    const groups: Record<string, any[]> = {};
    for (const inv of invoices) {
      const vendor = inv.vendors?.name || inv.vendor_name || 'Unknown Vendor';
      if (!groups[vendor]) groups[vendor] = [];
      groups[vendor].push(inv);
    }

    // Sort vendor names alphabetically
    const sortedVendors = Object.keys(groups).sort((a, b) => a.localeCompare(b));

    let html = '';
    for (const vendor of sortedVendors) {
      const vendorInvoices = groups[vendor];
      const vendorTotal = vendorInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
      html += `<tr class="bg-base-200 vendor-group-header"><td colspan="9" class="font-bold">${escapeHtml(vendor)} (${vendorInvoices.length} invoice${vendorInvoices.length !== 1 ? 's' : ''} - ${formatCurrency(vendorTotal)})</td></tr>`;
      html += vendorInvoices.map((inv) => buildInvoiceRow(inv)).join('');
    }

    tableBody.innerHTML = html;
  }

  function renderPagination(pagination: any) {
    if (!pagination || pagination.total_pages <= 1) {
      paginationSection.classList.add('hidden');
      return;
    }

    paginationSection.classList.remove('hidden');
    paginationSection.style.display = 'flex';

    const { page, limit, total, total_pages } = pagination;
    const start = (page - 1) * limit + 1;
    const end = Math.min(page * limit, total);

    paginationInfo.textContent = `Showing ${start}-${end} of ${total} invoices`;

    // Prev/Next buttons
    pagePrev.disabled = page <= 1;
    pageNext.disabled = page >= total_pages;

    // Generate page number buttons
    const pages = generatePageNumbers(page, total_pages);
    pageNumbers.innerHTML = pages
      .map((p) => {
        if (p === '...') {
          return `<button class="join-item btn btn-sm btn-disabled no-underline" disabled>...</button>`;
        }
        const isActive = p === page;
        return `<button class="join-item btn btn-sm no-underline ${isActive ? 'btn-active' : ''}" data-page="${p}">${p}</button>`;
      })
      .join('');

    // Attach page number click handlers
    pageNumbers.querySelectorAll('button[data-page]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetPage = parseInt((btn as HTMLElement).dataset.page || '1', 10);
        if (targetPage !== currentPage) {
          currentPage = targetPage;
          loadDashboard();
        }
      });
    });
  }

  function generatePageNumbers(current: number, total: number): (number | string)[] {
    if (total <= 7) {
      return Array.from({ length: total }, (_, i) => i + 1);
    }

    const pages: (number | string)[] = [1];

    if (current > 3) pages.push('...');

    const rangeStart = Math.max(2, current - 1);
    const rangeEnd = Math.min(total - 1, current + 1);

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (current < total - 2) pages.push('...');

    pages.push(total);

    return pages;
  }

  function showError(message: string) {
    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableContainer.classList.add('hidden');
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableError.classList.remove('hidden');
    tableError.style.display = 'flex';
    tableErrorMessage.textContent = message;
  }

  function showLoading() {
    tableLoading.classList.remove('hidden');
    tableLoading.style.display = 'flex';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.add('hidden');
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── Time Range Helpers ───────────────────────────────────────────
  function computeDateFrom(range: string): string {
    const now = new Date();
    switch (range) {
      case 'today': {
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return start.toISOString();
      }
      case 'week': {
        // Start of this week (Monday)
        const day = now.getDay();
        const diff = day === 0 ? 6 : day - 1; // Monday = 0 offset
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diff);
        return start.toISOString();
      }
      case 'month': {
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return start.toISOString();
      }
      case 'all':
      default:
        return '';
    }
  }

  function setActiveRangeButton(range: string) {
    timeRangeButtons.querySelectorAll('button').forEach((btn) => {
      if (btn.dataset.range === range) {
        btn.classList.add('btn-active');
      } else {
        btn.classList.remove('btn-active');
      }
    });
  }

  // ─── CSV Export ───────────────────────────────────────────────────
  function exportCsv() {
    const filtered = applyClientFilters(allInvoices);
    const headers = ['invoice_number', 'vendor', 'amount', 'date', 'due_date', 'status', 'confidence'];
    const rows = filtered.map((inv) => {
      const vendor = inv.vendors?.name || inv.vendor_name || '';
      const amount = inv.total != null ? String(inv.total) : '';
      const date = inv.invoice_date || '';
      const dueDate = inv.due_date || '';
      const status = inv.status || '';
      const confidence = inv.confidence != null ? String(Math.round(inv.confidence * 100)) + '%' : '';
      return [inv.invoice_number || '', vendor, amount, date, dueDate, status, confidence];
    });

    let csvContent = headers.join(',') + '\n';
    for (const row of rows) {
      csvContent += row.map((cell) => {
        // Escape cells containing commas, quotes, or newlines
        const escaped = String(cell).replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(',') + '\n';
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `invoices-export-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // ─── Main Load Function ───────────────────────────────────────────
  async function loadDashboard() {
    showLoading();

    try {
      const data = await fetchDashboard();

      renderStats(data.summary);

      allInvoices = data.invoices || [];
      renderTable(allInvoices);
      renderPagination(data.pagination);
    } catch (err: any) {
      console.error('Dashboard load error:', err);
      showError(err.message || 'An unexpected error occurred.');
    }
  }

  // ─── Bulk Action Handlers ─────────────────────────────────────────
  async function executeBulkAction(action: 'approve' | 'reject') {
    if (selectedInvoices.size === 0) return;

    const ids = Array.from(selectedInvoices);
    const confirmMsg = `Are you sure you want to ${action} ${ids.length} invoice${ids.length !== 1 ? 's' : ''}?`;
    if (!confirm(confirmMsg)) return;

    try {
      for (const id of ids) {
        await callApproveEndpoint(id, action);
      }
      selectedInvoices.clear();
      selectAllCheckbox.checked = false;
      updateBulkUI();
      await loadDashboard();
    } catch (err: any) {
      console.error(`Bulk ${action} error:`, err);
      alert(`Failed to ${action} some invoices: ${err.message}`);
      await loadDashboard();
    }
  }

  // ─── Event Listeners ─────────────────────────────────────────────

  // Time range buttons
  timeRangeButtons.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => {
      const range = (btn as HTMLElement).dataset.range || 'all';
      currentDateFrom = computeDateFrom(range);
      setActiveRangeButton(range);
      currentPage = 1;
      loadDashboard();
    });
  });

  // Status filter -> triggers API call (server-side filter)
  filterStatus.addEventListener('change', () => {
    currentStatus = filterStatus.value;
    currentPage = 1;
    loadDashboard();
  });

  // Per-page limit -> triggers API call
  filterLimit.addEventListener('change', () => {
    currentLimit = parseInt(filterLimit.value, 10);
    currentPage = 1;
    loadDashboard();
  });

  // Search -> client-side filter with debounce
  filterSearch.addEventListener('input', () => {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      currentSearch = filterSearch.value;
      renderTable(allInvoices);
    }, 250);
  });

  // Sort -> client-side re-sort
  filterSort.addEventListener('change', () => {
    currentSort = filterSort.value;
    renderTable(allInvoices);
  });

  // Pagination prev/next
  pagePrev.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadDashboard();
    }
  });

  pageNext.addEventListener('click', () => {
    currentPage++;
    loadDashboard();
  });

  // Retry on error
  retryBtn.addEventListener('click', () => {
    loadDashboard();
  });

  // Select All checkbox
  selectAllCheckbox.addEventListener('change', () => {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.checked = selectAllCheckbox.checked;
      const id = cb.dataset.invoiceId!;
      if (selectAllCheckbox.checked) {
        selectedInvoices.add(id);
      } else {
        selectedInvoices.delete(id);
      }
    });
    updateBulkUI();
  });

  // Bulk action buttons
  bulkApproveBtn.addEventListener('click', () => executeBulkAction('approve'));
  bulkRejectBtn.addEventListener('click', () => executeBulkAction('reject'));
  bulkCancelBtn.addEventListener('click', () => {
    selectedInvoices.clear();
    selectAllCheckbox.checked = false;
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => { cb.checked = false; });
    updateBulkUI();
  });

  // CSV Export
  exportCsvBtn.addEventListener('click', () => exportCsv());

  // Vendor Group Toggle
  toggleVendorGroupBtn.addEventListener('click', () => {
    vendorGroupMode = !vendorGroupMode;
    toggleVendorGroupBtn.classList.toggle('btn-active', vendorGroupMode);
    renderTable(allInvoices);
  });

  // ─── Initial Load ────────────────────────────────────────────────
  loadDashboard();

  // ─── Auto-refresh every 30 seconds ─────────────────────────────
  setInterval(() => {
    loadDashboard();
  }, 30000);
</script>
</DashboardLayout>
