---
export const prerender = false;
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Dashboard">
  <!-- ===== Summary Stats Cards (4 cards) ===== -->
  <div id="stats-section" class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-2">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-3 sm:p-4">
        <p class="text-[10px] sm:text-xs uppercase tracking-wide opacity-60 font-semibold">Needs Review</p>
        <p id="stat-needs-review" class="text-xl sm:text-2xl font-bold mt-1 text-warning">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-3 sm:p-4">
        <p class="text-[10px] sm:text-xs uppercase tracking-wide opacity-60 font-semibold">Approved</p>
        <p id="stat-approved" class="text-xl sm:text-2xl font-bold mt-1 text-success">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-3 sm:p-4">
        <p class="text-[10px] sm:text-xs uppercase tracking-wide opacity-60 font-semibold leading-tight">Amount Awaiting</p>
        <p id="stat-amount-awaiting" class="text-xl sm:text-2xl font-bold mt-1 text-info truncate">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-3 sm:p-4">
        <p class="text-[10px] sm:text-xs uppercase tracking-wide opacity-60 font-semibold">Amt Approved</p>
        <p id="stat-amount-approved" class="text-xl sm:text-2xl font-bold mt-1 text-success truncate">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
  </div>

  <!-- ===== All-time total line ===== -->
  <p id="stat-total-line" class="text-sm opacity-50 mt-2 mb-4 text-center"></p>

  <!-- ===== Analytics Charts ===== -->
  <details class="collapse collapse-arrow bg-base-100 shadow-sm mb-4" id="analytics-section">
    <summary class="collapse-title font-semibold text-sm">Analytics &amp; Insights</summary>
    <div class="collapse-content">
      <div id="analytics-loading" class="flex items-center justify-center py-8 hidden">
        <span class="loading loading-spinner loading-md text-primary"></span>
        <span class="ml-3 text-sm opacity-60">Loading analytics...</span>
      </div>
      <div id="analytics-error" class="hidden text-center py-8">
        <p class="text-sm opacity-50">Analytics coming soon.</p>
      </div>
      <div id="analytics-content" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pt-4">
          <!-- Invoice Volume Chart -->
          <div>
            <h3 class="text-sm font-semibold mb-3 opacity-60">Invoice Volume (Last 30 Days)</h3>
            <canvas id="chart-volume" height="200"></canvas>
          </div>
          <!-- Spend by Vendor Chart -->
          <div>
            <h3 class="text-sm font-semibold mb-3 opacity-60">Top Vendors by Spend</h3>
            <canvas id="chart-vendors" height="200"></canvas>
          </div>
          <!-- Status Breakdown Chart -->
          <div>
            <h3 class="text-sm font-semibold mb-3 opacity-60">Status Breakdown</h3>
            <canvas id="chart-status" height="200"></canvas>
          </div>
          <!-- Quick Stats -->
          <div>
            <h3 class="text-sm font-semibold mb-3 opacity-60">Processing Performance</h3>
            <div class="stats stats-vertical shadow w-full">
              <div class="stat">
                <div class="stat-title">Avg Confidence Score</div>
                <div class="stat-value text-lg" id="stat-avg-confidence">--</div>
              </div>
              <div class="stat">
                <div class="stat-title">Avg Processing Time</div>
                <div class="stat-value text-lg" id="stat-avg-processing">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </details>

  <!-- ===== Time Range Preset Buttons ===== -->
  <div class="flex flex-wrap gap-2 mb-4" id="time-range-buttons">
    <button class="btn btn-sm" data-range="today">Today</button>
    <button class="btn btn-sm" data-range="week">This Week</button>
    <button class="btn btn-sm" data-range="month">This Month</button>
    <button class="btn btn-sm btn-active" data-range="all">All Time</button>
  </div>

  <!-- ===== Filters & Search Bar ===== -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body p-4">
      <!-- Mobile: 2-col grid for compact filters. Desktop: flex row -->
      <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-3 items-start sm:items-end">
        <!-- Search (full width on all) -->
        <div class="form-control col-span-2 sm:flex-1 sm:min-w-[180px]">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Search</span>
          </label>
          <input
            id="filter-search"
            type="text"
            placeholder="Search vendor or invoice #..."
            class="input input-bordered input-sm w-full"
          />
        </div>

        <!-- Status Filter -->
        <div class="form-control sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Status</span>
          </label>
          <select id="filter-status" class="select select-bordered select-sm w-full">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="flagged">Flagged</option>
            <option value="rejected">Rejected</option>
            <option value="synced">Synced</option>
            <option value="error">Error</option>
          </select>
        </div>

        <!-- Sort -->
        <div class="form-control sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Sort By</span>
          </label>
          <select id="filter-sort" class="select select-bordered select-sm w-full">
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
            <option value="amount-desc">Amount (High-Low)</option>
            <option value="amount-asc">Amount (Low-High)</option>
          </select>
        </div>

        <!-- Per-page limit -->
        <div class="form-control sm:w-32">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Per Page</span>
          </label>
          <select id="filter-limit" class="select select-bordered select-sm w-full">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <!-- Vendor Group Toggle & Export CSV -->
        <div class="flex gap-2 col-span-2 sm:w-auto">
          <button id="toggle-vendor-group" class="btn btn-sm btn-outline flex-1 sm:flex-none">Group by Vendor</button>
          <button id="export-csv" class="btn btn-sm btn-outline flex-1 sm:flex-none">Export CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Invoice Table ===== -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-0">
      <!-- Loading state -->
      <div id="table-loading" class="flex flex-col items-center justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-3 text-sm opacity-60">Loading invoices...</p>
      </div>

      <!-- Error state -->
      <div id="table-error" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-error mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <p class="font-semibold text-error">Failed to load invoices</p>
        <p id="table-error-message" class="text-sm opacity-60 mt-1"></p>
        <button id="retry-btn" class="btn btn-sm btn-primary mt-4 no-underline">Retry</button>
      </div>

      <!-- Empty state -->
      <div id="table-empty" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-30 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="font-semibold">No invoices found</p>
        <p class="text-sm opacity-60 mt-1">Try adjusting your filters or search term.</p>
      </div>

      <!-- Table -->
      <div id="table-container" class="hidden overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr class="border-b border-base-200">
              <th class="w-10"><input type="checkbox" id="select-all" class="checkbox checkbox-sm" /></th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Invoice #</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Vendor</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Amount</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden sm:table-cell">Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden md:table-cell">Due Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Status</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden lg:table-cell">Confidence</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody id="invoice-table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Bulk Actions Bar ===== -->
  <div id="bulk-actions" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-base-300 rounded-box shadow-xl p-3 flex flex-wrap items-center justify-center gap-2 sm:gap-3 z-50 w-[calc(100%-2rem)] sm:w-auto max-w-lg">
    <span id="bulk-count" class="text-sm font-medium w-full text-center sm:w-auto">0 selected</span>
    <button id="bulk-approve" class="btn btn-sm btn-success flex-1 sm:flex-none min-w-0">Approve</button>
    <button id="bulk-reject" class="btn btn-sm btn-error flex-1 sm:flex-none min-w-0">Reject</button>
    <button id="bulk-delete" class="btn btn-sm btn-error btn-outline flex-1 sm:flex-none min-w-0">Delete</button>
    <button id="bulk-cancel" class="btn btn-sm btn-ghost flex-1 sm:flex-none min-w-0">Cancel</button>
  </div>

  <!-- ===== Toast Notification Container ===== -->
  <div id="toast-container" class="toast toast-top toast-end z-[100]"></div>

  <!-- ===== Pagination ===== -->
  <div id="pagination-section" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p id="pagination-info" class="text-sm opacity-60"></p>
    <div class="join">
      <button id="page-prev" class="join-item btn btn-sm no-underline" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Prev
      </button>
      <div id="page-numbers" class="join-item hidden sm:flex">
        <!-- Page buttons injected by JS -->
      </div>
      <button id="page-next" class="join-item btn btn-sm no-underline">
        Next
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- ===== Activity Feed ===== -->
  <details class="collapse collapse-arrow bg-base-100 shadow-sm mt-6">
    <summary class="collapse-title text-sm font-semibold">Recent Activity</summary>
    <div class="collapse-content" id="activity-feed">
      <p class="text-sm opacity-50 py-2">Activity feed coming soon.</p>
    </div>
  </details>
</DashboardLayout>

<style>
  /* Make table rows clickable-looking */
  #invoice-table-body tr {
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #invoice-table-body tr:hover {
    background-color: oklch(var(--b2));
  }
  /* Vendor group header rows should not look clickable */
  #invoice-table-body tr.vendor-group-header {
    cursor: default;
  }
  /* Remove default anchor underline from rows */
  #invoice-table-body tr a {
    text-decoration: none;
  }
  /* Smooth fade-in for content */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in {
    animation: fadeIn 0.3s ease forwards;
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  // ─── Constants & Config ───────────────────────────────────────────
  const FUNCTIONS_URL = 'https://tcgptxbqqyxmvsaqiblc.supabase.co/functions/v1';
  const API_BASE = `${FUNCTIONS_URL}/admin-get-dashboard`;
  const APPROVE_URL = `${FUNCTIONS_URL}/approve-invoice`;
  const BULK_ACTION_URL = `${FUNCTIONS_URL}/admin-bulk-action`;

  // ─── State ────────────────────────────────────────────────────────
  let currentPage = 1;
  let currentLimit = 25;
  let currentStatus = '';
  let currentSort = 'date-desc';
  let currentSearch = '';
  let currentDateFrom = '';
  let allInvoices: any[] = [];
  let selectedInvoices: Set<string> = new Set();
  let vendorGroupMode = false;
  let searchDebounceTimer: ReturnType<typeof setTimeout> | null = null;

  // ─── DOM Elements ─────────────────────────────────────────────────
  const statNeedsReview = document.getElementById('stat-needs-review')!;
  const statApproved = document.getElementById('stat-approved')!;
  const statAmountAwaiting = document.getElementById('stat-amount-awaiting')!;
  const statAmountApproved = document.getElementById('stat-amount-approved')!;
  const statTotalLine = document.getElementById('stat-total-line')!;

  const filterSearch = document.getElementById('filter-search') as HTMLInputElement;
  const filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
  const filterSort = document.getElementById('filter-sort') as HTMLSelectElement;
  const filterLimit = document.getElementById('filter-limit') as HTMLSelectElement;

  const tableLoading = document.getElementById('table-loading')!;
  const tableError = document.getElementById('table-error')!;
  const tableErrorMessage = document.getElementById('table-error-message')!;
  const tableEmpty = document.getElementById('table-empty')!;
  const tableContainer = document.getElementById('table-container')!;
  const tableBody = document.getElementById('invoice-table-body')!;
  const retryBtn = document.getElementById('retry-btn')!;

  const paginationSection = document.getElementById('pagination-section')!;
  const paginationInfo = document.getElementById('pagination-info')!;
  const pageNumbers = document.getElementById('page-numbers')!;
  const pagePrev = document.getElementById('page-prev') as HTMLButtonElement;
  const pageNext = document.getElementById('page-next') as HTMLButtonElement;

  const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
  const bulkActions = document.getElementById('bulk-actions')!;
  const bulkCountEl = document.getElementById('bulk-count')!;
  const bulkApproveBtn = document.getElementById('bulk-approve')!;
  const bulkRejectBtn = document.getElementById('bulk-reject')!;
  const bulkDeleteBtn = document.getElementById('bulk-delete')!;
  const bulkCancelBtn = document.getElementById('bulk-cancel')!;

  const exportCsvBtn = document.getElementById('export-csv')!;
  const toggleVendorGroupBtn = document.getElementById('toggle-vendor-group')!;

  const timeRangeButtons = document.getElementById('time-range-buttons')!;

  // ─── Formatters ───────────────────────────────────────────────────
  const currencyFormatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  const dateFormatter = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });

  function formatDate(dateStr: string | null): string {
    if (!dateStr) return '--';
    try {
      return dateFormatter.format(new Date(dateStr));
    } catch {
      return dateStr;
    }
  }

  function formatCurrency(amount: number | null | undefined): string {
    if (amount == null) return '--';
    return currencyFormatter.format(amount);
  }

  function formatConfidence(confidence: number | null | undefined): { text: string; class: string } {
    if (confidence == null) return { text: '--', class: 'opacity-40' };
    const pct = Math.round(confidence * 100);
    if (pct >= 90) return { text: `${pct}%`, class: 'text-success font-semibold' };
    if (pct >= 70) return { text: `${pct}%`, class: 'text-warning font-semibold' };
    return { text: `${pct}%`, class: 'text-error font-semibold' };
  }

  // ─── Status Badge ─────────────────────────────────────────────────
  function getStatusBadge(status: string): string {
    const map: Record<string, { class: string; label: string; icon?: string }> = {
      pending:  { class: 'badge-warning',  label: 'Pending' },
      approved: { class: 'badge-success',  label: 'Approved' },
      flagged:  { class: 'badge-error',    label: 'Flagged', icon: '\u26A0' },
      rejected: { class: 'badge-error',    label: 'Rejected' },
      synced:   { class: 'badge-info',     label: 'Synced' },
      error:    { class: 'badge-error',    label: 'Error' },
    };
    const info = map[status] || { class: 'badge-ghost', label: status };
    const iconHtml = info.icon ? `${info.icon} ` : '';
    return `<span class="badge badge-sm ${info.class} gap-1">${iconHtml}${info.label}</span>`;
  }

  // ─── Auth ──────────────────────────────────────────────────────────
  async function getAuthToken(): Promise<string | null> {
    const { data: { session } } = await supabase.auth.getSession();
    return session?.access_token ?? null;
  }

  // ─── API Fetch ────────────────────────────────────────────────────
  async function fetchDashboard(): Promise<any> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const params = new URLSearchParams();
    params.set('page', String(currentPage));
    params.set('limit', String(currentLimit));
    if (currentStatus) params.set('status', currentStatus);
    if (currentDateFrom) params.set('date_from', currentDateFrom);

    const url = `${API_BASE}?${params.toString()}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`API error ${response.status}: ${errorBody}`);
    }

    return response.json();
  }

  // ─── Approve/Reject API ───────────────────────────────────────────
  async function callApproveEndpoint(invoiceId: string, action: 'approve' | 'reject'): Promise<void> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const response = await fetch(APPROVE_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ invoice_id: invoiceId, action }),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`Approve API error ${response.status}: ${errorBody}`);
    }
  }

  // ─── Bulk Action API (single request for multiple invoices) ────────
  async function callBulkActionEndpoint(
    action: 'approve' | 'reject' | 'delete' | 'export_csv',
    invoiceIds: string[]
  ): Promise<Response> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const response = await fetch(BULK_ACTION_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ action, invoice_ids: invoiceIds }),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`Bulk action API error ${response.status}: ${errorBody}`);
    }

    return response;
  }

  // ─── Toast Notifications ───────────────────────────────────────────
  function showToast(message: string, type: 'success' | 'error' | 'info' = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;

    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} shadow-lg text-sm transition-all duration-300 opacity-0 translate-y-2`;
    toast.innerHTML = `<span>${escapeHtml(message)}</span>`;
    toastContainer.appendChild(toast);

    // Trigger entrance animation
    requestAnimationFrame(() => {
      toast.classList.remove('opacity-0', 'translate-y-2');
      toast.classList.add('opacity-100', 'translate-y-0');
    });

    // Auto-dismiss after 4 seconds
    setTimeout(() => {
      toast.classList.remove('opacity-100', 'translate-y-0');
      toast.classList.add('opacity-0', 'translate-y-2');
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ─── Quick Action (single row approve/reject) ─────────────────────
  (window as any).quickAction = async function(invoiceId: string, action: 'approve' | 'reject') {
    try {
      await callApproveEndpoint(invoiceId, action);
      await loadDashboard();
    } catch (err: any) {
      console.error('Quick action error:', err);
      alert(`Failed to ${action} invoice: ${err.message}`);
    }
  };

  // ─── Client-Side Sorting & Filtering ──────────────────────────────
  function applyClientFilters(invoices: any[]): any[] {
    let filtered = [...invoices];

    // Search filter (client-side, across vendor_id and invoice_number)
    if (currentSearch.trim()) {
      const term = currentSearch.trim().toLowerCase();
      filtered = filtered.filter((inv) => {
        const invoiceNum = (inv.invoice_number || '').toLowerCase();
        const vendorId = (inv.vendor_id || '').toLowerCase();
        const vendorName = (inv.vendor_name || inv.vendors?.name || '').toLowerCase();
        return invoiceNum.includes(term) || vendorId.includes(term) || vendorName.includes(term);
      });
    }

    // Sort
    filtered.sort((a, b) => {
      switch (currentSort) {
        case 'date-asc':
          return new Date(a.invoice_date || 0).getTime() - new Date(b.invoice_date || 0).getTime();
        case 'date-desc':
          return new Date(b.invoice_date || 0).getTime() - new Date(a.invoice_date || 0).getTime();
        case 'amount-asc':
          return (a.total || 0) - (b.total || 0);
        case 'amount-desc':
          return (b.total || 0) - (a.total || 0);
        default:
          return 0;
      }
    });

    return filtered;
  }

  // ─── Checkbox / Bulk Selection Helpers ─────────────────────────────
  function updateBulkUI() {
    const count = selectedInvoices.size;
    if (count > 0) {
      bulkActions.classList.remove('hidden');
      bulkActions.style.display = 'flex';
      bulkCountEl.textContent = `${count} selected`;
    } else {
      bulkActions.classList.add('hidden');
      bulkActions.style.display = '';
    }
  }

  function bindCheckboxEvents() {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.addEventListener('change', (e) => {
        e.stopPropagation();
        const id = cb.dataset.invoiceId!;
        if (cb.checked) {
          selectedInvoices.add(id);
        } else {
          selectedInvoices.delete(id);
        }
        // Update select-all state
        selectAllCheckbox.checked = checkboxes.length > 0 && selectedInvoices.size === checkboxes.length;
        updateBulkUI();
      });
    });
  }

  // ─── Render Functions ─────────────────────────────────────────────
  function renderStats(summary: any) {
    statNeedsReview.textContent = String(summary.needs_review ?? 0);
    statApproved.textContent = String(summary.approved ?? 0);
    statAmountAwaiting.textContent = formatCurrency(summary.amount_awaiting_approval);
    statAmountApproved.textContent = formatCurrency(summary.amount_approved);

    // All-time total line
    const totalInvoices = summary.total_invoices ?? 0;
    statTotalLine.textContent = `${totalInvoices} invoice${totalInvoices !== 1 ? 's' : ''} processed all-time`;

    // Notify the nav bell about failed processing count
    const failedProcessing = summary.failed_processing ?? 0;
    window.dispatchEvent(new CustomEvent('dashboard:notifications', {
      detail: { failedCount: failedProcessing }
    }));

    // Animate in
    document.getElementById('stats-section')?.classList.add('fade-in');
  }

  function buildInvoiceRow(inv: any): string {
    const conf = formatConfidence(inv.confidence);
    const vendorDisplay = inv.vendors?.name || inv.vendor_name || '--';
    const isPendingOrFlagged = inv.status === 'pending' || inv.status === 'flagged';
    const isChecked = selectedInvoices.has(inv.id) ? 'checked' : '';

    const actionsHtml = isPendingOrFlagged
      ? `<td><div class="flex gap-1">
           <button onclick="event.stopPropagation(); quickAction('${inv.id}', 'approve')" class="btn btn-xs btn-success btn-outline" title="Approve">\u2713</button>
           <button onclick="event.stopPropagation(); quickAction('${inv.id}', 'reject')" class="btn btn-xs btn-error btn-outline" title="Reject">\u2717</button>
         </div></td>`
      : `<td></td>`;

    return `
      <tr onclick="window.location.href='/invoice/${inv.id}'" class="border-b border-base-200/50 hover:bg-base-200/50 cursor-pointer transition-colors">
        <td onclick="event.stopPropagation()"><input type="checkbox" class="checkbox checkbox-sm row-checkbox" data-invoice-id="${inv.id}" ${isChecked} /></td>
        <td class="font-mono text-sm font-medium">${escapeHtml(inv.invoice_number || '--')}</td>
        <td class="max-w-[120px] sm:max-w-[200px] truncate">${escapeHtml(vendorDisplay)}</td>
        <td class="font-mono font-medium">${formatCurrency(inv.total)}</td>
        <td class="hidden sm:table-cell text-sm">${formatDate(inv.invoice_date)}</td>
        <td class="hidden md:table-cell text-sm">${formatDate(inv.due_date)}</td>
        <td>${getStatusBadge(inv.status || 'pending')}</td>
        <td class="hidden lg:table-cell"><span class="${conf.class}">${conf.text}</span></td>
        ${actionsHtml}
      </tr>
    `;
  }

  function renderTable(invoices: any[]) {
    const filtered = applyClientFilters(invoices);

    // Show/hide states
    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';

    if (filtered.length === 0) {
      tableEmpty.classList.remove('hidden');
      tableEmpty.style.display = 'flex';
      tableContainer.classList.add('hidden');
      return;
    }

    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.remove('hidden');
    tableContainer.classList.add('fade-in');

    if (vendorGroupMode) {
      renderVendorGroupedTable(filtered);
    } else {
      tableBody.innerHTML = filtered.map((inv) => buildInvoiceRow(inv)).join('');
    }

    bindCheckboxEvents();
    updateBulkUI();
  }

  function renderVendorGroupedTable(invoices: any[]) {
    // Group by vendor
    const groups: Record<string, any[]> = {};
    for (const inv of invoices) {
      const vendor = inv.vendors?.name || inv.vendor_name || 'Unknown Vendor';
      if (!groups[vendor]) groups[vendor] = [];
      groups[vendor].push(inv);
    }

    // Sort vendor names alphabetically
    const sortedVendors = Object.keys(groups).sort((a, b) => a.localeCompare(b));

    let html = '';
    for (const vendor of sortedVendors) {
      const vendorInvoices = groups[vendor];
      const vendorTotal = vendorInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
      html += `<tr class="bg-base-200 vendor-group-header"><td colspan="9" class="font-bold">${escapeHtml(vendor)} (${vendorInvoices.length} invoice${vendorInvoices.length !== 1 ? 's' : ''} - ${formatCurrency(vendorTotal)})</td></tr>`;
      html += vendorInvoices.map((inv) => buildInvoiceRow(inv)).join('');
    }

    tableBody.innerHTML = html;
  }

  function renderPagination(pagination: any) {
    if (!pagination || pagination.total_pages <= 1) {
      paginationSection.classList.add('hidden');
      return;
    }

    paginationSection.classList.remove('hidden');
    paginationSection.style.display = 'flex';

    const { page, limit, total, total_pages } = pagination;
    const start = (page - 1) * limit + 1;
    const end = Math.min(page * limit, total);

    paginationInfo.textContent = `Showing ${start}-${end} of ${total} invoices`;

    // Prev/Next buttons
    pagePrev.disabled = page <= 1;
    pageNext.disabled = page >= total_pages;

    // Generate page number buttons
    const pages = generatePageNumbers(page, total_pages);
    pageNumbers.innerHTML = pages
      .map((p) => {
        if (p === '...') {
          return `<button class="join-item btn btn-sm btn-disabled no-underline" disabled>...</button>`;
        }
        const isActive = p === page;
        return `<button class="join-item btn btn-sm no-underline ${isActive ? 'btn-active' : ''}" data-page="${p}">${p}</button>`;
      })
      .join('');

    // Attach page number click handlers
    pageNumbers.querySelectorAll('button[data-page]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetPage = parseInt((btn as HTMLElement).dataset.page || '1', 10);
        if (targetPage !== currentPage) {
          currentPage = targetPage;
          loadDashboard();
        }
      });
    });
  }

  function generatePageNumbers(current: number, total: number): (number | string)[] {
    if (total <= 7) {
      return Array.from({ length: total }, (_, i) => i + 1);
    }

    const pages: (number | string)[] = [1];

    if (current > 3) pages.push('...');

    const rangeStart = Math.max(2, current - 1);
    const rangeEnd = Math.min(total - 1, current + 1);

    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }

    if (current < total - 2) pages.push('...');

    pages.push(total);

    return pages;
  }

  function showError(message: string) {
    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableContainer.classList.add('hidden');
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableError.classList.remove('hidden');
    tableError.style.display = 'flex';
    tableErrorMessage.textContent = message;
  }

  function showLoading() {
    tableLoading.classList.remove('hidden');
    tableLoading.style.display = 'flex';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.add('hidden');
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── Time Range Helpers ───────────────────────────────────────────
  function computeDateFrom(range: string): string {
    const now = new Date();
    switch (range) {
      case 'today': {
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return start.toISOString();
      }
      case 'week': {
        // Start of this week (Monday)
        const day = now.getDay();
        const diff = day === 0 ? 6 : day - 1; // Monday = 0 offset
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diff);
        return start.toISOString();
      }
      case 'month': {
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return start.toISOString();
      }
      case 'all':
      default:
        return '';
    }
  }

  function setActiveRangeButton(range: string) {
    timeRangeButtons.querySelectorAll('button').forEach((btn) => {
      if (btn.dataset.range === range) {
        btn.classList.add('btn-active');
      } else {
        btn.classList.remove('btn-active');
      }
    });
  }

  // ─── CSV Export ───────────────────────────────────────────────────
  async function exportCsv() {
    // If invoices are selected, use the server-side bulk export for full-fidelity CSV
    if (selectedInvoices.size > 0) {
      const ids = Array.from(selectedInvoices);
      try {
        showToast(`Exporting ${ids.length} selected invoice${ids.length !== 1 ? 's' : ''}...`, 'info');
        const response = await callBulkActionEndpoint('export_csv', ids);
        const csvText = await response.text();

        const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `invoices-export-${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast(`Exported ${ids.length} invoice${ids.length !== 1 ? 's' : ''} successfully.`, 'success');
      } catch (err: any) {
        console.error('Server CSV export error:', err);
        showToast(`CSV export failed: ${err.message}`, 'error');
      }
      return;
    }

    // Fall back to client-side export for the current filtered view
    const filtered = applyClientFilters(allInvoices);
    const headers = ['invoice_number', 'vendor', 'amount', 'date', 'due_date', 'status', 'confidence'];
    const rows = filtered.map((inv) => {
      const vendor = inv.vendors?.name || inv.vendor_name || '';
      const amount = inv.total != null ? String(inv.total) : '';
      const date = inv.invoice_date || '';
      const dueDate = inv.due_date || '';
      const status = inv.status || '';
      const confidence = inv.confidence != null ? String(Math.round(inv.confidence * 100)) + '%' : '';
      return [inv.invoice_number || '', vendor, amount, date, dueDate, status, confidence];
    });

    let csvContent = headers.join(',') + '\n';
    for (const row of rows) {
      csvContent += row.map((cell) => {
        // Escape cells containing commas, quotes, or newlines
        const escaped = String(cell).replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(',') + '\n';
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `invoices-export-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // ─── Main Load Function ───────────────────────────────────────────
  async function loadDashboard() {
    showLoading();

    try {
      const data = await fetchDashboard();

      renderStats(data.summary);

      allInvoices = data.invoices || [];
      renderTable(allInvoices);
      renderPagination(data.pagination);
    } catch (err: any) {
      console.error('Dashboard load error:', err);
      showError(err.message || 'An unexpected error occurred.');
    }
  }

  // ─── Bulk Action Handlers ─────────────────────────────────────────
  async function executeBulkAction(action: 'approve' | 'reject' | 'delete') {
    if (selectedInvoices.size === 0) return;

    const ids = Array.from(selectedInvoices);
    const actionLabel = action === 'delete' ? 'delete' : action;
    const confirmMsg = `Are you sure you want to ${actionLabel} ${ids.length} invoice${ids.length !== 1 ? 's' : ''}?`;
    if (!confirm(confirmMsg)) return;

    try {
      const response = await callBulkActionEndpoint(action, ids);
      const result = await response.json();

      selectedInvoices.clear();
      selectAllCheckbox.checked = false;
      updateBulkUI();

      // Show feedback via toast
      if (result.errors && result.errors.length > 0) {
        showToast(
          `${result.processed} invoice${result.processed !== 1 ? 's' : ''} ${actionLabel}d. ${result.errors.length} failed.`,
          result.processed > 0 ? 'info' : 'error'
        );
      } else {
        showToast(
          `${result.processed} invoice${result.processed !== 1 ? 's' : ''} ${actionLabel}d successfully.`,
          'success'
        );
      }

      await loadDashboard();
    } catch (err: any) {
      console.error(`Bulk ${action} error:`, err);
      showToast(`Failed to ${actionLabel} invoices: ${err.message}`, 'error');
      await loadDashboard();
    }
  }

  // ─── Event Listeners ─────────────────────────────────────────────

  // Time range buttons
  timeRangeButtons.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => {
      const range = (btn as HTMLElement).dataset.range || 'all';
      currentDateFrom = computeDateFrom(range);
      setActiveRangeButton(range);
      currentPage = 1;
      loadDashboard();
    });
  });

  // Status filter -> triggers API call (server-side filter)
  filterStatus.addEventListener('change', () => {
    currentStatus = filterStatus.value;
    currentPage = 1;
    loadDashboard();
  });

  // Per-page limit -> triggers API call
  filterLimit.addEventListener('change', () => {
    currentLimit = parseInt(filterLimit.value, 10);
    currentPage = 1;
    loadDashboard();
  });

  // Search -> client-side filter with debounce
  filterSearch.addEventListener('input', () => {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      currentSearch = filterSearch.value;
      renderTable(allInvoices);
    }, 250);
  });

  // Sort -> client-side re-sort
  filterSort.addEventListener('change', () => {
    currentSort = filterSort.value;
    renderTable(allInvoices);
  });

  // Pagination prev/next
  pagePrev.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadDashboard();
    }
  });

  pageNext.addEventListener('click', () => {
    currentPage++;
    loadDashboard();
  });

  // Retry on error
  retryBtn.addEventListener('click', () => {
    loadDashboard();
  });

  // Select All checkbox
  selectAllCheckbox.addEventListener('change', () => {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.checked = selectAllCheckbox.checked;
      const id = cb.dataset.invoiceId!;
      if (selectAllCheckbox.checked) {
        selectedInvoices.add(id);
      } else {
        selectedInvoices.delete(id);
      }
    });
    updateBulkUI();
  });

  // Bulk action buttons
  bulkApproveBtn.addEventListener('click', () => executeBulkAction('approve'));
  bulkRejectBtn.addEventListener('click', () => executeBulkAction('reject'));
  bulkDeleteBtn.addEventListener('click', () => executeBulkAction('delete'));
  bulkCancelBtn.addEventListener('click', () => {
    selectedInvoices.clear();
    selectAllCheckbox.checked = false;
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => { cb.checked = false; });
    updateBulkUI();
  });

  // CSV Export
  exportCsvBtn.addEventListener('click', () => { exportCsv(); });

  // Vendor Group Toggle
  toggleVendorGroupBtn.addEventListener('click', () => {
    vendorGroupMode = !vendorGroupMode;
    toggleVendorGroupBtn.classList.toggle('btn-active', vendorGroupMode);
    renderTable(allInvoices);
  });

  // ─── Analytics: Chart.js Loader ──────────────────────────────────
  async function loadChartJs(): Promise<any> {
    if ((window as any).Chart) return (window as any).Chart;
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      script.onload = () => resolve((window as any).Chart);
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // ─── Analytics: Data Fetching ──────────────────────────────────
  let analyticsCache: any = null;
  let analyticsChartInstances: any[] = [];

  async function fetchAnalytics() {
    const token = await getAuthToken();
    if (!token) return null;

    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

    const params = new URLSearchParams({
      date_from: thirtyDaysAgo.toISOString(),
      date_to: new Date().toISOString()
    });

    const res = await fetch(`${FUNCTIONS_URL}/admin-get-analytics?${params}`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) return null;
    return res.json();
  }

  // ─── Analytics: Chart Color Schemes ────────────────────────────
  const CHART_COLORS = {
    primary: '#570df8',
    success: '#36d399',
    warning: '#fbbd23',
    error: '#f87272',
    info: '#3abff8',
  };

  const STATUS_COLOR_MAP: Record<string, string> = {
    pending: CHART_COLORS.warning,
    approved: CHART_COLORS.success,
    flagged: CHART_COLORS.error,
    rejected: '#a8a8a8',
    synced: CHART_COLORS.info,
    error: CHART_COLORS.error,
  };

  // ─── Analytics: Rendering ──────────────────────────────────────
  function renderAnalyticsCharts(data: any, Chart: any) {
    // Destroy any existing chart instances to prevent canvas reuse issues
    for (const chart of analyticsChartInstances) {
      chart.destroy();
    }
    analyticsChartInstances = [];

    const analyticsContent = document.getElementById('analytics-content')!;
    analyticsContent.classList.remove('hidden');

    // --- Volume Chart (Line) ---
    const volumeCtx = (document.getElementById('chart-volume') as HTMLCanvasElement)?.getContext('2d');
    if (volumeCtx && data.volume) {
      const labels = data.volume.map((d: any) => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const values = data.volume.map((d: any) => d.count);

      const volumeChart = new Chart(volumeCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Invoices',
            data: values,
            borderColor: CHART_COLORS.primary,
            backgroundColor: CHART_COLORS.primary + '20',
            fill: true,
            tension: 0.3,
            pointRadius: 2,
            pointHoverRadius: 5,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { color: 'rgba(0,0,0,0.05)' },
            },
            x: {
              grid: { display: false },
              ticks: { maxTicksLimit: 10 },
            }
          }
        }
      });
      analyticsChartInstances.push(volumeChart);
    }

    // --- Vendors Chart (Horizontal Bar) ---
    const vendorsCtx = (document.getElementById('chart-vendors') as HTMLCanvasElement)?.getContext('2d');
    if (vendorsCtx && data.top_vendors) {
      const vendorLabels = data.top_vendors.map((v: any) => {
        const name = v.vendor_name || v.name || 'Unknown';
        return name.length > 20 ? name.substring(0, 20) + '...' : name;
      });
      const vendorValues = data.top_vendors.map((v: any) => v.total_spend || v.amount || 0);

      const vendorsChart = new Chart(vendorsCtx, {
        type: 'bar',
        data: {
          labels: vendorLabels,
          datasets: [{
            label: 'Total Spend',
            data: vendorValues,
            backgroundColor: CHART_COLORS.info + 'CC',
            borderColor: CHART_COLORS.info,
            borderWidth: 1,
            borderRadius: 3,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx: any) => {
                  return ' $' + Number(ctx.raw).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: {
                callback: (value: any) => '$' + Number(value).toLocaleString('en-US', { notation: 'compact' } as any),
              }
            },
            y: {
              grid: { display: false },
            }
          }
        }
      });
      analyticsChartInstances.push(vendorsChart);
    }

    // --- Status Chart (Doughnut) ---
    const statusCtx = (document.getElementById('chart-status') as HTMLCanvasElement)?.getContext('2d');
    if (statusCtx && data.status_breakdown) {
      const statusLabels = data.status_breakdown.map((s: any) =>
        (s.status || 'unknown').charAt(0).toUpperCase() + (s.status || 'unknown').slice(1)
      );
      const statusValues = data.status_breakdown.map((s: any) => s.count);
      const statusColors = data.status_breakdown.map((s: any) =>
        STATUS_COLOR_MAP[s.status] || '#d1d5db'
      );

      const statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusValues,
            backgroundColor: statusColors,
            borderWidth: 2,
            borderColor: '#fff',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: { padding: 12, usePointStyle: true, pointStyle: 'circle' },
            },
          },
          cutout: '55%',
        }
      });
      analyticsChartInstances.push(statusChart);
    }

    // --- Quick Stats ---
    if (data.avg_confidence != null) {
      const avgConfEl = document.getElementById('stat-avg-confidence');
      if (avgConfEl) {
        avgConfEl.textContent = Math.round(data.avg_confidence * 100) + '%';
      }
    }
    if (data.avg_processing_time != null) {
      const avgProcEl = document.getElementById('stat-avg-processing');
      if (avgProcEl) {
        const seconds = Number(data.avg_processing_time);
        avgProcEl.textContent = seconds < 60
          ? seconds.toFixed(1) + 's'
          : (seconds / 60).toFixed(1) + 'min';
      }
    }
  }

  // ─── Analytics: Toggle Handler (Lazy Load) ─────────────────────
  const analyticsSection = document.getElementById('analytics-section') as HTMLDetailsElement;
  const analyticsLoading = document.getElementById('analytics-loading')!;
  const analyticsError = document.getElementById('analytics-error')!;
  const analyticsContent = document.getElementById('analytics-content')!;

  if (analyticsSection) {
    analyticsSection.addEventListener('toggle', async () => {
      if (!analyticsSection.open) return;

      // If already cached, don't re-fetch
      if (analyticsCache) return;

      analyticsLoading.classList.remove('hidden');
      analyticsError.classList.add('hidden');
      analyticsContent.classList.add('hidden');

      try {
        const [Chart, data] = await Promise.all([
          loadChartJs(),
          fetchAnalytics(),
        ]);

        analyticsLoading.classList.add('hidden');

        if (!data || !Chart) {
          analyticsError.classList.remove('hidden');
          return;
        }

        analyticsCache = data;
        renderAnalyticsCharts(data, Chart);
      } catch (err) {
        console.error('Analytics load error:', err);
        analyticsLoading.classList.add('hidden');
        analyticsError.classList.remove('hidden');
      }
    });
  }

  // ─── Initial Load ────────────────────────────────────────────────
  loadDashboard();

  // ─── Auto-refresh every 30 seconds ─────────────────────────────
  setInterval(() => {
    loadDashboard();
  }, 30000);
</script>
</DashboardLayout>
