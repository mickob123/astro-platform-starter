---
export const prerender = false;
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Vendors">
  <!-- Back + Breadcrumb -->
  <div class="flex items-center gap-3 mb-4">
    <a href="/dashboard"
       class="btn btn-sm btn-ghost gap-1 no-underline">
      <svg xmlns="http://www.w3.org/2000/svg"
           class="h-4 w-4" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round"
              stroke-linejoin="round" stroke-width="2"
              d="M15 19l-7-7 7-7" />
      </svg>
      Back
    </a>
    <div class="text-sm breadcrumbs">
      <ul>
        <li>
          <a href="/dashboard"
             class="no-underline text-base-content/60
                    hover:text-base-content">
            Dashboard
          </a>
        </li>
        <li class="text-base-content font-medium">
          Vendors
        </li>
      </ul>
    </div>
  </div>

  <div class="flex items-center justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold">Vendors</h1>
      <p class="text-sm opacity-50 mt-1">View and manage your vendor relationships</p>
    </div>
  </div>

  <!-- Search -->
  <div class="form-control w-full max-w-md mb-6">
    <input id="vendor-search" type="text" class="input input-bordered input-sm" placeholder="Search vendors..." />
  </div>

  <!-- Vendor Cards Grid -->
  <div id="vendors-loading" class="flex justify-center py-12">
    <span class="loading loading-spinner loading-lg"></span>
  </div>
  <div id="vendors-empty" class="hidden text-center py-12 opacity-50">
    <p>No vendors found.</p>
  </div>
  <div id="vendors-grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
</DashboardLayout>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in {
    animation: fadeIn 0.3s ease forwards;
  }
</style>

<script>
  import { supabase } from '../lib/supabase';

  // ─── Constants ──────────────────────────────────────────────────
  const SUPABASE_URL = 'https://tcgptxbqqyxmvsaqiblc.supabase.co';
  const SUPABASE_ANON_KEY =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjZ3B0eGJxcXl4bXZzYXFpYmxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzOTQwODksImV4cCI6MjA4NTk3MDA4OX0.nyTEkolz8sft-qFoHpwsLl4F4JkIEW7A3c8aPGftprc';

  // ─── Types ──────────────────────────────────────────────────────
  interface VendorInvoice {
    id: string;
    total: number | null;
    status: string;
    created_at: string;
  }

  interface Vendor {
    id: string;
    name: string;
    normalized_name: string | null;
    created_at: string;
    invoices: VendorInvoice[];
  }

  // ─── State ──────────────────────────────────────────────────────
  let allVendors: Vendor[] = [];
  let searchDebounceTimer: ReturnType<typeof setTimeout> | null = null;

  // ─── DOM References ─────────────────────────────────────────────
  const vendorSearch = document.getElementById('vendor-search') as HTMLInputElement;
  const vendorsLoading = document.getElementById('vendors-loading')!;
  const vendorsEmpty = document.getElementById('vendors-empty')!;
  const vendorsGrid = document.getElementById('vendors-grid')!;

  // ─── Formatters ─────────────────────────────────────────────────
  const currencyFormatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  const dateFormatter = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });

  function formatCurrency(amount: number): string {
    return currencyFormatter.format(amount);
  }

  function formatDate(dateStr: string): string {
    try {
      return dateFormatter.format(new Date(dateStr));
    } catch {
      return dateStr;
    }
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── Status Badge ──────────────────────────────────────────────
  function getStatusBadgeClass(status: string): string {
    const map: Record<string, string> = {
      pending: 'badge-warning',
      approved: 'badge-success',
      flagged: 'badge-error',
      rejected: 'badge-error',
      synced: 'badge-info',
      error: 'badge-error',
    };
    return map[status] || 'badge-ghost';
  }

  // ─── Fetch Vendors ─────────────────────────────────────────────
  async function fetchVendors(): Promise<void> {
    vendorsLoading.classList.remove('hidden');
    vendorsEmpty.classList.add('hidden');
    vendorsGrid.classList.add('hidden');

    try {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = '/login';
        return;
      }

      const url = `${SUPABASE_URL}/rest/v1/vendors?select=id,name,normalized_name,created_at,invoices(id,total,status,created_at)&order=name.asc`;

      const res = await fetch(url, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${session.access_token}`,
          'Content-Type': 'application/json',
        },
      });

      if (!res.ok) {
        // Handle gracefully if endpoint is not available
        console.warn('Vendors endpoint returned', res.status);
        allVendors = [];
      } else {
        const data = await res.json();
        allVendors = Array.isArray(data) ? data : [];
      }
    } catch (err) {
      console.warn('Could not fetch vendors:', err);
      allVendors = [];
    }

    renderVendors(allVendors);
  }

  // ─── Render Vendors ────────────────────────────────────────────
  function renderVendors(vendors: Vendor[]): void {
    vendorsLoading.classList.add('hidden');

    if (vendors.length === 0) {
      vendorsEmpty.classList.remove('hidden');
      vendorsGrid.classList.add('hidden');
      return;
    }

    vendorsEmpty.classList.add('hidden');
    vendorsGrid.classList.remove('hidden');
    vendorsGrid.classList.add('fade-in');

    vendorsGrid.innerHTML = vendors.map(vendor => {
      const invoices = vendor.invoices || [];
      const totalInvoices = invoices.length;
      const totalSpend = invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);

      // Find latest invoice date
      let latestDate = '';
      if (invoices.length > 0) {
        const sorted = [...invoices].sort(
          (a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
        );
        latestDate = sorted[0].created_at;
      }

      // Count statuses
      const pendingCount = invoices.filter(inv => inv.status === 'pending' || inv.status === 'flagged').length;
      const approvedCount = invoices.filter(inv => inv.status === 'approved' || inv.status === 'synced').length;
      const errorCount = invoices.filter(inv => inv.status === 'error' || inv.status === 'rejected').length;

      return `
        <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow">
          <div class="card-body p-5">
            <h3 class="card-title text-lg">${escapeHtml(vendor.name)}</h3>

            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <p class="text-xs uppercase tracking-wide opacity-50 font-semibold">Invoices</p>
                <p class="text-xl font-bold mt-0.5">${totalInvoices}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide opacity-50 font-semibold">Total Spend</p>
                <p class="text-xl font-bold mt-0.5">${formatCurrency(totalSpend)}</p>
              </div>
            </div>

            ${latestDate ? `
              <div class="mt-3">
                <p class="text-xs uppercase tracking-wide opacity-50 font-semibold">Latest Invoice</p>
                <p class="text-sm mt-0.5">${formatDate(latestDate)}</p>
              </div>
            ` : ''}

            <div class="flex flex-wrap gap-2 mt-3">
              ${pendingCount > 0 ? `<span class="badge badge-sm badge-warning gap-1">${pendingCount} pending</span>` : ''}
              ${approvedCount > 0 ? `<span class="badge badge-sm badge-success gap-1">${approvedCount} approved</span>` : ''}
              ${errorCount > 0 ? `<span class="badge badge-sm badge-error gap-1">${errorCount} rejected/error</span>` : ''}
              ${totalInvoices === 0 ? `<span class="badge badge-sm badge-ghost">No invoices</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // ─── Search / Filter ───────────────────────────────────────────
  function filterVendors(term: string): void {
    const lower = term.toLowerCase().trim();
    if (!lower) {
      renderVendors(allVendors);
      return;
    }

    const filtered = allVendors.filter(vendor => {
      const name = (vendor.name || '').toLowerCase();
      const normalized = (vendor.normalized_name || '').toLowerCase();
      return name.includes(lower) || normalized.includes(lower);
    });

    renderVendors(filtered);
  }

  vendorSearch.addEventListener('input', () => {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      filterVendors(vendorSearch.value);
    }, 250);
  });

  // ─── Initial Load ──────────────────────────────────────────────
  fetchVendors();
</script>
