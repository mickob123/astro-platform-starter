---
export const prerender = false;
import DashboardLayout from '../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Expenses">
  <!-- ===== Summary Stats Cards (4 cards) ===== -->
  <div id="stats-section" class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-2">
    <div class="card bg-base-100 stat-card-review">
      <div class="card-body p-3 sm:p-4">
        <p class="stat-label">Needs Review</p>
        <p id="stat-needs-review" class="text-xl sm:text-2xl font-bold mt-1 text-warning">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 stat-card-approved">
      <div class="card-body p-3 sm:p-4">
        <p class="stat-label">Approved</p>
        <p id="stat-approved" class="text-xl sm:text-2xl font-bold mt-1 text-success">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 stat-card-amount">
      <div class="card-body p-3 sm:p-4">
        <p class="stat-label">Amount Awaiting</p>
        <p id="stat-amount-awaiting" class="text-xl sm:text-2xl stat-value-mono mt-1 text-info truncate">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
    <div class="card bg-base-100 stat-card-approved">
      <div class="card-body p-3 sm:p-4">
        <p class="stat-label">Amt Approved</p>
        <p id="stat-amount-approved" class="text-xl sm:text-2xl stat-value-mono mt-1 text-success truncate">
          <span class="loading loading-dots loading-sm"></span>
        </p>
      </div>
    </div>
  </div>

  <!-- ===== All-time total line ===== -->
  <p id="stat-total-line" class="text-sm opacity-50 mt-2 mb-4 text-center"></p>

  <!-- ===== Time Range Preset Buttons ===== -->
  <div class="period-tabs mb-4" id="time-range-buttons">
    <button class="period-tab" data-range="today">Today</button>
    <button class="period-tab" data-range="week">This Week</button>
    <button class="period-tab" data-range="month">This Month</button>
    <button class="period-tab active" data-range="all">All Time</button>
  </div>

  <!-- ===== Filters & Search Bar ===== -->
  <div class="filter-bar mb-6">
    <div class="">
      <div class="grid grid-cols-2 sm:flex sm:flex-wrap gap-3 items-start sm:items-end">
        <!-- Search -->
        <div class="form-control col-span-2 sm:flex-1 sm:min-w-[180px]">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Search</span>
          </label>
          <input
            id="filter-search"
            type="text"
            placeholder="Search vendor or receipt #..."
            class="input input-bordered input-sm w-full"
          />
        </div>

        <!-- Status Filter -->
        <div class="form-control sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Status</span>
          </label>
          <select id="filter-status" class="select select-bordered select-sm w-full">
            <option value="">All Statuses</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="flagged">Flagged</option>
            <option value="rejected">Rejected</option>
            <option value="synced">Synced</option>
            <option value="error">Error</option>
          </select>
        </div>

        <!-- Sort -->
        <div class="form-control sm:w-48">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Sort By</span>
          </label>
          <select id="filter-sort" class="select select-bordered select-sm w-full">
            <option value="date-desc">Date (Newest)</option>
            <option value="date-asc">Date (Oldest)</option>
            <option value="amount-desc">Amount (High-Low)</option>
            <option value="amount-asc">Amount (Low-High)</option>
          </select>
        </div>

        <!-- Per-page limit -->
        <div class="form-control sm:w-32">
          <label class="label py-1">
            <span class="label-text text-xs font-semibold uppercase tracking-wide opacity-60">Per Page</span>
          </label>
          <select id="filter-limit" class="select select-bordered select-sm w-full">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>

        <!-- Vendor Group Toggle & Export CSV -->
        <div class="flex gap-2 col-span-2 sm:w-auto">
          <button id="toggle-vendor-group" class="btn btn-sm btn-outline flex-1 sm:flex-none">Group by Vendor</button>
          <button id="export-csv" class="btn btn-sm btn-outline flex-1 sm:flex-none">Export CSV</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Expense Table ===== -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-0">
      <!-- Loading state -->
      <div id="table-loading" class="flex flex-col items-center justify-center py-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-3 text-sm opacity-60">Loading expenses...</p>
      </div>

      <!-- Error state -->
      <div id="table-error" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-error mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
        <p class="font-semibold text-error">Failed to load expenses</p>
        <p id="table-error-message" class="text-sm opacity-60 mt-1"></p>
        <button id="retry-btn" class="btn btn-sm btn-primary mt-4 no-underline">Retry</button>
      </div>

      <!-- Empty state -->
      <div id="table-empty" class="hidden flex-col items-center justify-center py-16 px-4 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 opacity-30 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <p class="font-semibold">No expenses found</p>
        <p class="text-sm opacity-60 mt-1">Expenses from emails (receipts, subscriptions) will appear here automatically.</p>
      </div>

      <!-- Table -->
      <div id="table-container" class="hidden overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr class="border-b border-base-200">
              <th class="w-10 admin-only"><input type="checkbox" id="select-all" class="checkbox checkbox-sm" /></th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Receipt #</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Vendor</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Amount</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden sm:table-cell">Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden md:table-cell">Payment Date</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold">Status</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold hidden lg:table-cell">Confidence</th>
              <th class="text-xs uppercase tracking-wide opacity-60 font-semibold admin-only">Actions</th>
            </tr>
          </thead>
          <tbody id="expense-table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===== Bulk Actions Bar ===== -->
  <div id="bulk-actions" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-base-300 rounded-box shadow-xl p-3 flex flex-wrap items-center justify-center gap-2 sm:gap-3 z-50 w-[calc(100%-2rem)] sm:w-auto max-w-lg admin-only">
    <span id="bulk-count" class="text-sm font-medium w-full text-center sm:w-auto">0 selected</span>
    <button id="bulk-approve" class="btn btn-sm btn-success flex-1 sm:flex-none min-w-0">Approve</button>
    <button id="bulk-reject" class="btn btn-sm btn-error flex-1 sm:flex-none min-w-0">Reject</button>
    <button id="bulk-delete" class="btn btn-sm btn-error btn-outline flex-1 sm:flex-none min-w-0">Delete</button>
    <button id="bulk-reclassify" class="btn btn-sm btn-warning btn-outline flex-1 sm:flex-none min-w-0">→ Invoices</button>
    <button id="bulk-cancel" class="btn btn-sm btn-ghost flex-1 sm:flex-none min-w-0">Cancel</button>
  </div>

  <!-- ===== Toast Notification Container ===== -->
  <div id="toast-container" class="toast toast-top toast-end z-[100]"></div>

  <!-- ===== Pagination ===== -->
  <div id="pagination-section" class="hidden mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p id="pagination-info" class="text-sm opacity-60"></p>
    <div class="join">
      <button id="page-prev" class="join-item btn btn-sm no-underline" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Prev
      </button>
      <div id="page-numbers" class="join-item hidden sm:flex">
        <!-- Page buttons injected by JS -->
      </div>
      <button id="page-next" class="join-item btn btn-sm no-underline">
        Next
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>
</DashboardLayout>

<style>
  #expense-table-body tr {
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  #expense-table-body tr:hover {
    background-color: oklch(var(--b2));
  }
  #expense-table-body tr.vendor-group-header {
    cursor: default;
  }
  #expense-table-body tr a {
    text-decoration: none;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .fade-in {
    animation: fadeIn 0.3s ease forwards;
  }
</style>

<script>
  import { supabase, getAccessToken } from '../lib/supabase';

  // ─── Constants & Config ───────────────────────────────────────────
  const FUNCTIONS_URL = 'https://tcgptxbqqyxmvsaqiblc.supabase.co/functions/v1';
  const API_BASE = `${FUNCTIONS_URL}/admin-get-dashboard`;
  const APPROVE_URL = `${FUNCTIONS_URL}/approve-invoice`;
  const BULK_ACTION_URL = `${FUNCTIONS_URL}/admin-bulk-action`;

  // ─── State ────────────────────────────────────────────────────────
  let currentPage = 1;
  let currentLimit = 25;
  let currentStatus = '';
  let currentSort = 'date-desc';
  let currentSearch = '';
  let currentDateFrom = '';
  let allExpenses: any[] = [];
  let selectedExpenses: Set<string> = new Set();
  let vendorGroupMode = false;
  let searchDebounceTimer: ReturnType<typeof setTimeout> | null = null;

  // ─── DOM Elements ─────────────────────────────────────────────────
  const statNeedsReview = document.getElementById('stat-needs-review')!;
  const statApproved = document.getElementById('stat-approved')!;
  const statAmountAwaiting = document.getElementById('stat-amount-awaiting')!;
  const statAmountApproved = document.getElementById('stat-amount-approved')!;
  const statTotalLine = document.getElementById('stat-total-line')!;

  const filterSearch = document.getElementById('filter-search') as HTMLInputElement;
  const filterStatus = document.getElementById('filter-status') as HTMLSelectElement;
  const filterSort = document.getElementById('filter-sort') as HTMLSelectElement;
  const filterLimit = document.getElementById('filter-limit') as HTMLSelectElement;

  const tableLoading = document.getElementById('table-loading')!;
  const tableError = document.getElementById('table-error')!;
  const tableErrorMessage = document.getElementById('table-error-message')!;
  const tableEmpty = document.getElementById('table-empty')!;
  const tableContainer = document.getElementById('table-container')!;
  const tableBody = document.getElementById('expense-table-body')!;
  const retryBtn = document.getElementById('retry-btn')!;

  const paginationSection = document.getElementById('pagination-section')!;
  const paginationInfo = document.getElementById('pagination-info')!;
  const pageNumbers = document.getElementById('page-numbers')!;
  const pagePrev = document.getElementById('page-prev') as HTMLButtonElement;
  const pageNext = document.getElementById('page-next') as HTMLButtonElement;

  const selectAllCheckbox = document.getElementById('select-all') as HTMLInputElement;
  const bulkActions = document.getElementById('bulk-actions')!;
  const bulkCountEl = document.getElementById('bulk-count')!;
  const bulkApproveBtn = document.getElementById('bulk-approve')!;
  const bulkRejectBtn = document.getElementById('bulk-reject')!;
  const bulkDeleteBtn = document.getElementById('bulk-delete')!;
  const bulkReclassifyBtn = document.getElementById('bulk-reclassify')!;
  const bulkCancelBtn = document.getElementById('bulk-cancel')!;

  const exportCsvBtn = document.getElementById('export-csv')!;
  const toggleVendorGroupBtn = document.getElementById('toggle-vendor-group')!;

  const timeRangeButtons = document.getElementById('time-range-buttons')!;

  // ─── Formatters ───────────────────────────────────────────────────
  const currencyFormatter = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });

  const dateFormatter = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
  });

  function formatDate(dateStr: string | null): string {
    if (!dateStr) return '--';
    try {
      return dateFormatter.format(new Date(dateStr));
    } catch {
      return dateStr;
    }
  }

  function formatCurrency(amount: number | null | undefined): string {
    if (amount == null) return '--';
    return currencyFormatter.format(amount);
  }

  function formatConfidence(confidence: number | null | undefined): { text: string; class: string } {
    if (confidence == null) return { text: '--', class: 'opacity-40' };
    const pct = Math.round(confidence * 100);
    if (pct >= 90) return { text: `${pct}%`, class: 'confidence-high' };
    if (pct >= 70) return { text: `${pct}%`, class: 'confidence-medium' };
    return { text: `${pct}%`, class: 'confidence-low' };
  }

  // ─── Status Badge ─────────────────────────────────────────────────
  function getStatusBadge(status: string): string {
    const map: Record<string, { class: string; label: string; icon?: string }> = {
      pending:  { class: 'badge-warning',  label: 'Pending' },
      approved: { class: 'badge-success',  label: 'Approved' },
      flagged:  { class: 'badge-error',    label: 'Flagged', icon: '\u26A0' },
      rejected: { class: 'badge-error',    label: 'Rejected' },
      synced:   { class: 'badge-info',     label: 'Synced' },
      error:    { class: 'badge-error',    label: 'Error' },
    };
    const info = map[status] || { class: 'badge-ghost', label: status };
    const iconHtml = info.icon ? `${info.icon} ` : '';
    return `<span class="badge badge-sm badge-dot ${info.class} gap-1">${info.label}</span>`;
  }

  function getSyncBadge(syncStatus: string | null): string {
    if (!syncStatus) return '';
    const map: Record<string, { class: string; label: string; icon: string }> = {
      pending: { class: 'badge-ghost', label: 'Syncing', icon: '\u21BB' },
      synced:  { class: 'badge-info badge-outline', label: 'QB', icon: '\u2713' },
      failed:  { class: 'badge-error badge-outline', label: 'Sync Failed', icon: '\u26A0' },
      skipped: { class: 'badge-ghost badge-outline', label: 'No QB', icon: '\u2014' },
    };
    const info = map[syncStatus];
    if (!info) return '';
    return `<span class="badge badge-sm ${info.class} gap-1 ml-1" title="QuickBooks: ${info.label}">${info.icon} ${info.label}</span>`;
  }

  // ─── Auth ──────────────────────────────────────────────────────────
  async function getAuthToken(): Promise<string | null> {
    return await getAccessToken();
  }

  // ─── API Fetch (expense-specific: document_type=expense) ─────────
  async function fetchExpenses(): Promise<any> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const params = new URLSearchParams();
    params.set('page', String(currentPage));
    params.set('limit', String(currentLimit));
    params.set('document_type', 'expense');
    if (currentStatus) params.set('status', currentStatus);
    if (currentDateFrom) params.set('date_from', currentDateFrom);

    const url = `${API_BASE}?${params.toString()}`;

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`API error ${response.status}: ${errorBody}`);
    }

    return response.json();
  }

  // ─── Approve/Reject API ───────────────────────────────────────────
  async function callApproveEndpoint(expenseId: string, action: 'approve' | 'reject'): Promise<void> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const response = await fetch(APPROVE_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ invoice_id: expenseId, action }),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`Approve API error ${response.status}: ${errorBody}`);
    }
  }

  // ─── Bulk Action API ──────────────────────────────────────────────
  async function callBulkActionEndpoint(
    action: 'approve' | 'reject' | 'delete' | 'reclassify' | 'export_csv',
    expenseIds: string[]
  ): Promise<Response> {
    const token = await getAuthToken();
    if (!token) {
      window.location.href = '/login';
      throw new Error('Not authenticated');
    }

    const response = await fetch(BULK_ACTION_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ action, invoice_ids: expenseIds }),
    });

    if (!response.ok) {
      const errorBody = await response.text();
      throw new Error(`Bulk action API error ${response.status}: ${errorBody}`);
    }

    return response;
  }

  // ─── Toast Notifications ───────────────────────────────────────────
  function showToast(message: string, type: 'success' | 'error' | 'info' = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;

    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
    const toast = document.createElement('div');
    toast.className = `alert ${alertClass} shadow-lg text-sm transition-all duration-300 opacity-0 translate-y-2`;
    toast.innerHTML = `<span>${escapeHtml(message)}</span>`;
    toastContainer.appendChild(toast);

    requestAnimationFrame(() => {
      toast.classList.remove('opacity-0', 'translate-y-2');
      toast.classList.add('opacity-100', 'translate-y-0');
    });

    setTimeout(() => {
      toast.classList.remove('opacity-100', 'translate-y-0');
      toast.classList.add('opacity-0', 'translate-y-2');
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // ─── Quick Action (single row approve/reject) ─────────────────────
  (window as any).quickAction = async function(expenseId: string, action: 'approve' | 'reject') {
    try {
      await callApproveEndpoint(expenseId, action);
      await loadExpenses();
    } catch (err: any) {
      console.error('Quick action error:', err);
      alert(`Failed to ${action} expense: ${err.message}`);
    }
  };

  // ─── Client-Side Sorting & Filtering ──────────────────────────────
  function applyClientFilters(expenses: any[]): any[] {
    let filtered = [...expenses];

    if (currentSearch.trim()) {
      const term = currentSearch.trim().toLowerCase();
      filtered = filtered.filter((exp) => {
        const receiptNum = (exp.invoice_number || '').toLowerCase();
        const vendorId = (exp.vendor_id || '').toLowerCase();
        const vendorName = (exp.vendor_name || exp.vendors?.name || '').toLowerCase();
        return receiptNum.includes(term) || vendorId.includes(term) || vendorName.includes(term);
      });
    }

    filtered.sort((a, b) => {
      switch (currentSort) {
        case 'date-asc':
          return new Date(a.invoice_date || 0).getTime() - new Date(b.invoice_date || 0).getTime();
        case 'date-desc':
          return new Date(b.invoice_date || 0).getTime() - new Date(a.invoice_date || 0).getTime();
        case 'amount-asc':
          return (a.total || 0) - (b.total || 0);
        case 'amount-desc':
          return (b.total || 0) - (a.total || 0);
        default:
          return 0;
      }
    });

    return filtered;
  }

  // ─── Checkbox / Bulk Selection Helpers ─────────────────────────────
  function updateBulkUI() {
    const count = selectedExpenses.size;
    if (count > 0) {
      bulkActions.classList.remove('hidden');
      bulkActions.style.display = 'flex';
      bulkCountEl.textContent = `${count} selected`;
    } else {
      bulkActions.classList.add('hidden');
      bulkActions.style.display = '';
    }
  }

  function bindCheckboxEvents() {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.addEventListener('change', (e) => {
        e.stopPropagation();
        const id = cb.dataset.expenseId!;
        if (cb.checked) {
          selectedExpenses.add(id);
        } else {
          selectedExpenses.delete(id);
        }
        selectAllCheckbox.checked = checkboxes.length > 0 && selectedExpenses.size === checkboxes.length;
        updateBulkUI();
      });
    });
  }

  // ─── Render Functions ─────────────────────────────────────────────
  function renderStats(summary: any) {
    statNeedsReview.textContent = String(summary.needs_review ?? 0);
    statApproved.textContent = String(summary.approved ?? 0);
    statAmountAwaiting.textContent = formatCurrency(summary.amount_awaiting_approval);
    statAmountApproved.textContent = formatCurrency(summary.amount_approved);

    const totalExpenses = summary.total_invoices ?? 0;
    statTotalLine.textContent = `${totalExpenses} expense${totalExpenses !== 1 ? 's' : ''} processed all-time`;

    const failedProcessing = summary.failed_processing ?? 0;
    window.dispatchEvent(new CustomEvent('dashboard:notifications', {
      detail: { failedCount: failedProcessing }
    }));

    document.getElementById('stats-section')?.classList.add('fade-in');
  }

  function buildExpenseRow(exp: any): string {
    const conf = formatConfidence(exp.confidence);
    const vendorDisplay = exp.vendors?.name || exp.vendor_name || '--';
    const isPendingOrFlagged = exp.status === 'pending' || exp.status === 'flagged';
    const isChecked = selectedExpenses.has(exp.id) ? 'checked' : '';

    const actionsHtml = isPendingOrFlagged
      ? `<td class="admin-only"><div class="flex gap-1">
           <button onclick="event.stopPropagation(); quickAction('${exp.id}', 'approve')" class="btn btn-xs btn-success btn-outline" title="Approve">\u2713</button>
           <button onclick="event.stopPropagation(); quickAction('${exp.id}', 'reject')" class="btn btn-xs btn-error btn-outline" title="Reject">\u2717</button>
         </div></td>`
      : `<td class="admin-only"></td>`;

    return `
      <tr onclick="window.location.href='/invoice/${exp.id}'" class="border-b border-base-200/50 hover:bg-base-200/50 cursor-pointer transition-colors">
        <td onclick="event.stopPropagation()" class="admin-only"><input type="checkbox" class="checkbox checkbox-sm row-checkbox" data-expense-id="${exp.id}" ${isChecked} /></td>
        <td class="font-data text-sm">${escapeHtml(exp.invoice_number || '--')}</td>
        <td class="max-w-[120px] sm:max-w-[200px] truncate">${escapeHtml(vendorDisplay)}</td>
        <td class="font-data">${formatCurrency(exp.total)}</td>
        <td class="hidden sm:table-cell text-sm">${formatDate(exp.invoice_date)}</td>
        <td class="hidden md:table-cell text-sm">${formatDate(exp.due_date || exp.invoice_date)}</td>
        <td><div class="flex flex-wrap items-center gap-0.5">${getStatusBadge(exp.status || 'pending')}${exp.status === 'approved' ? getSyncBadge(exp.sync_status) : ''}</div></td>
        <td class="hidden lg:table-cell"><span class="${conf.class}">${conf.text}</span></td>
        ${actionsHtml}
      </tr>
    `;
  }

  function renderTable(expenses: any[]) {
    const filtered = applyClientFilters(expenses);

    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';

    if (filtered.length === 0) {
      tableEmpty.classList.remove('hidden');
      tableEmpty.style.display = 'flex';
      tableContainer.classList.add('hidden');
      return;
    }

    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.remove('hidden');
    tableContainer.classList.add('fade-in');

    if (vendorGroupMode) {
      renderVendorGroupedTable(filtered);
    } else {
      tableBody.innerHTML = filtered.map((exp) => buildExpenseRow(exp)).join('');
    }

    bindCheckboxEvents();
    updateBulkUI();
  }

  function renderVendorGroupedTable(expenses: any[]) {
    const groups: Record<string, any[]> = {};
    for (const exp of expenses) {
      const vendor = exp.vendors?.name || exp.vendor_name || 'Unknown Vendor';
      if (!groups[vendor]) groups[vendor] = [];
      groups[vendor].push(exp);
    }

    const sortedVendors = Object.keys(groups).sort((a, b) => a.localeCompare(b));

    let html = '';
    for (const vendor of sortedVendors) {
      const vendorExpenses = groups[vendor];
      const vendorTotal = vendorExpenses.reduce((sum, exp) => sum + (exp.total || 0), 0);
      html += `<tr class="bg-base-200 vendor-group-header"><td colspan="9" class="font-bold">${escapeHtml(vendor)} (${vendorExpenses.length} expense${vendorExpenses.length !== 1 ? 's' : ''} - ${formatCurrency(vendorTotal)})</td></tr>`;
      html += vendorExpenses.map((exp) => buildExpenseRow(exp)).join('');
    }

    tableBody.innerHTML = html;
  }

  function renderPagination(pagination: any) {
    if (!pagination || pagination.total_pages <= 1) {
      paginationSection.classList.add('hidden');
      return;
    }

    paginationSection.classList.remove('hidden');
    paginationSection.style.display = 'flex';

    const { page, limit, total, total_pages } = pagination;
    const start = (page - 1) * limit + 1;
    const end = Math.min(page * limit, total);

    paginationInfo.textContent = `Showing ${start}-${end} of ${total} expenses`;

    pagePrev.disabled = page <= 1;
    pageNext.disabled = page >= total_pages;

    const pages = generatePageNumbers(page, total_pages);
    pageNumbers.innerHTML = pages
      .map((p) => {
        if (p === '...') {
          return `<button class="join-item btn btn-sm btn-disabled no-underline" disabled>...</button>`;
        }
        const isActive = p === page;
        return `<button class="join-item btn btn-sm no-underline ${isActive ? 'btn-active' : ''}" data-page="${p}">${p}</button>`;
      })
      .join('');

    pageNumbers.querySelectorAll('button[data-page]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const targetPage = parseInt((btn as HTMLElement).dataset.page || '1', 10);
        if (targetPage !== currentPage) {
          currentPage = targetPage;
          loadExpenses();
        }
      });
    });
  }

  function generatePageNumbers(current: number, total: number): (number | string)[] {
    if (total <= 7) {
      return Array.from({ length: total }, (_, i) => i + 1);
    }

    const pages: (number | string)[] = [1];
    if (current > 3) pages.push('...');
    const rangeStart = Math.max(2, current - 1);
    const rangeEnd = Math.min(total - 1, current + 1);
    for (let i = rangeStart; i <= rangeEnd; i++) {
      pages.push(i);
    }
    if (current < total - 2) pages.push('...');
    pages.push(total);
    return pages;
  }

  function showError(message: string) {
    tableLoading.classList.add('hidden');
    tableLoading.style.display = 'none';
    tableContainer.classList.add('hidden');
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableError.classList.remove('hidden');
    tableError.style.display = 'flex';
    tableErrorMessage.textContent = message;
  }

  function showLoading() {
    tableLoading.classList.remove('hidden');
    tableLoading.style.display = 'flex';
    tableError.classList.add('hidden');
    tableError.style.display = 'none';
    tableEmpty.classList.add('hidden');
    tableEmpty.style.display = 'none';
    tableContainer.classList.add('hidden');
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ─── Time Range Helpers ───────────────────────────────────────────
  function computeDateFrom(range: string): string {
    const now = new Date();
    switch (range) {
      case 'today': {
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        return start.toISOString();
      }
      case 'week': {
        const day = now.getDay();
        const diff = day === 0 ? 6 : day - 1;
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - diff);
        return start.toISOString();
      }
      case 'month': {
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return start.toISOString();
      }
      case 'all':
      default:
        return '';
    }
  }

  function setActiveRangeButton(range: string) {
    timeRangeButtons.querySelectorAll('.period-tab').forEach((btn) => {
      if ((btn as HTMLElement).dataset.range === range) {
        btn.classList.add('active');
      } else {
        btn.classList.remove('active');
      }
    });
  }

  // ─── CSV Export ───────────────────────────────────────────────────
  async function exportCsv() {
    if (selectedExpenses.size > 0) {
      const ids = Array.from(selectedExpenses);
      try {
        showToast(`Exporting ${ids.length} selected expense${ids.length !== 1 ? 's' : ''}...`, 'info');
        const response = await callBulkActionEndpoint('export_csv', ids);
        const csvText = await response.text();

        const blob = new Blob([csvText], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `expenses-export-${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        showToast(`Exported ${ids.length} expense${ids.length !== 1 ? 's' : ''} successfully.`, 'success');
      } catch (err: any) {
        console.error('Server CSV export error:', err);
        showToast(`CSV export failed: ${err.message}`, 'error');
      }
      return;
    }

    const filtered = applyClientFilters(allExpenses);
    const headers = ['receipt_number', 'vendor', 'amount', 'date', 'payment_date', 'status', 'confidence'];
    const rows = filtered.map((exp) => {
      const vendor = exp.vendors?.name || exp.vendor_name || '';
      const amount = exp.total != null ? String(exp.total) : '';
      const date = exp.invoice_date || '';
      const paymentDate = exp.due_date || exp.invoice_date || '';
      const status = exp.status || '';
      const confidence = exp.confidence != null ? String(Math.round(exp.confidence * 100)) + '%' : '';
      return [exp.invoice_number || '', vendor, amount, date, paymentDate, status, confidence];
    });

    let csvContent = headers.join(',') + '\n';
    for (const row of rows) {
      csvContent += row.map((cell) => {
        const escaped = String(cell).replace(/"/g, '""');
        return `"${escaped}"`;
      }).join(',') + '\n';
    }

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `expenses-export-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  // ─── Main Load Function ───────────────────────────────────────────
  async function loadExpenses() {
    showLoading();

    try {
      const data = await fetchExpenses();

      renderStats(data.summary);

      allExpenses = data.invoices || [];
      renderTable(allExpenses);
      renderPagination(data.pagination);
    } catch (err: any) {
      console.error('Expenses load error:', err);
      showError(err.message || 'An unexpected error occurred.');
    }
  }

  // ─── Bulk Action Handlers ─────────────────────────────────────────
  async function executeBulkAction(action: 'approve' | 'reject' | 'delete' | 'reclassify') {
    if (selectedExpenses.size === 0) return;

    const ids = Array.from(selectedExpenses);
    const actionLabel = action === 'reclassify' ? 'move to invoices' : action;
    const confirmMsg = action === 'reclassify'
      ? `Move ${ids.length} item${ids.length !== 1 ? 's' : ''} to Invoices?`
      : `Are you sure you want to ${actionLabel} ${ids.length} expense${ids.length !== 1 ? 's' : ''}?`;
    if (!confirm(confirmMsg)) return;

    try {
      const response = await callBulkActionEndpoint(action, ids);
      const result = await response.json();

      selectedExpenses.clear();
      selectAllCheckbox.checked = false;
      updateBulkUI();

      const n = result.processed;
      const noun = `${n} item${n !== 1 ? 's' : ''}`;
      const pastLabel = action === 'reclassify' ? 'moved to Invoices' : `${actionLabel}d`;
      if (result.errors && result.errors.length > 0) {
        showToast(`${noun} ${pastLabel}. ${result.errors.length} failed.`, n > 0 ? 'info' : 'error');
      } else {
        showToast(`${noun} ${pastLabel} successfully.`, 'success');
      }

      await loadExpenses();
    } catch (err: any) {
      console.error(`Bulk ${action} error:`, err);
      showToast(`Failed to ${actionLabel} expenses: ${err.message}`, 'error');
      await loadExpenses();
    }
  }

  // ─── Event Listeners ─────────────────────────────────────────────

  timeRangeButtons.querySelectorAll('button').forEach((btn) => {
    btn.addEventListener('click', () => {
      const range = (btn as HTMLElement).dataset.range || 'all';
      currentDateFrom = computeDateFrom(range);
      setActiveRangeButton(range);
      currentPage = 1;
      loadExpenses();
    });
  });

  filterStatus.addEventListener('change', () => {
    currentStatus = filterStatus.value;
    currentPage = 1;
    loadExpenses();
  });

  filterLimit.addEventListener('change', () => {
    currentLimit = parseInt(filterLimit.value, 10);
    currentPage = 1;
    loadExpenses();
  });

  filterSearch.addEventListener('input', () => {
    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
    searchDebounceTimer = setTimeout(() => {
      currentSearch = filterSearch.value;
      renderTable(allExpenses);
    }, 250);
  });

  filterSort.addEventListener('change', () => {
    currentSort = filterSort.value;
    renderTable(allExpenses);
  });

  pagePrev.addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      loadExpenses();
    }
  });

  pageNext.addEventListener('click', () => {
    currentPage++;
    loadExpenses();
  });

  retryBtn.addEventListener('click', () => {
    loadExpenses();
  });

  selectAllCheckbox.addEventListener('change', () => {
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => {
      cb.checked = selectAllCheckbox.checked;
      const id = cb.dataset.expenseId!;
      if (selectAllCheckbox.checked) {
        selectedExpenses.add(id);
      } else {
        selectedExpenses.delete(id);
      }
    });
    updateBulkUI();
  });

  bulkApproveBtn.addEventListener('click', () => executeBulkAction('approve'));
  bulkRejectBtn.addEventListener('click', () => executeBulkAction('reject'));
  bulkDeleteBtn.addEventListener('click', () => executeBulkAction('delete'));
  bulkReclassifyBtn.addEventListener('click', () => executeBulkAction('reclassify'));
  bulkCancelBtn.addEventListener('click', () => {
    selectedExpenses.clear();
    selectAllCheckbox.checked = false;
    const checkboxes = tableBody.querySelectorAll<HTMLInputElement>('.row-checkbox');
    checkboxes.forEach((cb) => { cb.checked = false; });
    updateBulkUI();
  });

  exportCsvBtn.addEventListener('click', () => { exportCsv(); });

  toggleVendorGroupBtn.addEventListener('click', () => {
    vendorGroupMode = !vendorGroupMode;
    toggleVendorGroupBtn.classList.toggle('btn-active', vendorGroupMode);
    renderTable(allExpenses);
  });

  // ─── Initial Load ────────────────────────────────────────────────
  loadExpenses();

  // ─── Auto-refresh every 30 seconds ─────────────────────────────
  setInterval(() => {
    loadExpenses();
  }, 30000);
</script>
</DashboardLayout>
