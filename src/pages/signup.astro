---
export const prerender = false;

import '../styles/globals.css';
import '../styles/docubot.css';
---

<!doctype html>
<html lang="en" data-theme="docubot">
  <head>
    <meta charset="UTF-8" />
    <title>Create Account | DocuBot</title>
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  </head>
  <body class="min-h-screen bg-base-200 flex items-center justify-center">

    <!-- Redirect if already logged in -->
    <script>
      import { supabase } from '../lib/supabase';
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        window.location.href = '/';
      } else {
        document.getElementById('signup-card')?.classList.remove('opacity-0');
      }
    </script>

    <div class="w-full max-w-md px-4">
      <div id="signup-card" class="card bg-base-100 shadow-xl opacity-0 transition-opacity duration-300">
        <div class="card-body gap-6">

          <!-- Header -->
          <div class="text-center">
            <h1 class="docubot-wordmark text-3xl sm:text-4xl">
              Docu<span class="bot">Bot</span>
            </h1>
            <p class="mt-2 text-sm text-base-content/60">
              Create your account
            </p>
          </div>

          <!-- Signup Form -->
          <form id="signup-form" class="flex flex-col gap-4">
            <div class="form-control w-full">
              <label class="label" for="company_name">
                <span class="label-text font-medium">Company Name</span>
              </label>
              <input
                id="company_name"
                name="company_name"
                type="text"
                required
                placeholder="Acme Corp"
                class="input input-bordered w-full focus:input-primary"
              />
            </div>

            <div class="form-control w-full">
              <label class="label" for="email">
                <span class="label-text font-medium">Email</span>
              </label>
              <input
                id="email"
                name="email"
                type="email"
                required
                autocomplete="email"
                placeholder="you@company.com"
                class="input input-bordered w-full focus:input-primary"
              />
            </div>

            <div class="form-control w-full">
              <label class="label" for="password">
                <span class="label-text font-medium">Password</span>
              </label>
              <input
                id="password"
                name="password"
                type="password"
                required
                minlength="8"
                autocomplete="new-password"
                placeholder="At least 8 characters"
                class="input input-bordered w-full focus:input-primary"
              />
            </div>

            <div class="form-control w-full">
              <label class="label" for="confirm_password">
                <span class="label-text font-medium">Confirm Password</span>
              </label>
              <input
                id="confirm_password"
                name="confirm_password"
                type="password"
                required
                minlength="8"
                autocomplete="new-password"
                placeholder="Repeat your password"
                class="input input-bordered w-full focus:input-primary"
              />
            </div>

            <button
              id="submit-btn"
              type="submit"
              class="btn btn-primary w-full mt-2"
            >
              <span id="btn-text">Create Account</span>
              <span id="btn-loading" class="loading loading-spinner loading-sm hidden"></span>
            </button>
          </form>

          <!-- Error Alert -->
          <div id="error-alert" class="alert alert-error hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="error-message"></span>
          </div>

          <!-- Success Alert (briefly shown before redirect) -->
          <div id="success-alert" class="alert alert-success hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            <span>Account created! Redirecting...</span>
          </div>

          <!-- Login link -->
          <div class="text-center text-sm">
            Already have an account?
            <a href="/login" class="link link-primary font-medium">Sign in</a>
          </div>

        </div>
      </div>

      <p class="text-center text-xs text-base-content/40 mt-6">
        By creating an account you agree to our
        <a href="/terms" class="link link-hover">Terms of Use</a> and
        <a href="/privacy" class="link link-hover">Privacy Policy</a>.
      </p>
      <p class="text-center text-xs text-base-content/40 mt-2">
        <a href="mailto:invoiceautomation@agentivegroup.ai" class="link link-hover">Contact Us</a>
      </p>
    </div>

    <!-- Signup handler -->
    <script>
      import { supabase, FUNCTIONS_URL } from '../lib/supabase';

      const form = document.getElementById('signup-form') as HTMLFormElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const btnText = document.getElementById('btn-text') as HTMLSpanElement;
      const btnLoading = document.getElementById('btn-loading') as HTMLSpanElement;
      const errorAlert = document.getElementById('error-alert') as HTMLDivElement;
      const errorMessage = document.getElementById('error-message') as HTMLSpanElement;
      const successAlert = document.getElementById('success-alert') as HTMLDivElement;

      function setLoading(loading: boolean) {
        submitBtn.disabled = loading;
        btnText.textContent = loading ? 'Creating account...' : 'Create Account';
        btnLoading.classList.toggle('hidden', !loading);
      }

      function showError(message: string) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('hidden');
        successAlert.classList.add('hidden');
      }

      function hideError() {
        errorAlert.classList.add('hidden');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        hideError();

        const formData = new FormData(form);
        const company_name = (formData.get('company_name') as string).trim();
        const email = (formData.get('email') as string).trim();
        const password = formData.get('password') as string;
        const confirmPassword = formData.get('confirm_password') as string;

        if (!company_name || !email || !password) {
          showError('Please fill in all fields.');
          return;
        }

        if (password !== confirmPassword) {
          showError('Passwords do not match.');
          return;
        }

        if (password.length < 8) {
          showError('Password must be at least 8 characters.');
          return;
        }

        setLoading(true);

        try {
          // Call the registration Edge Function
          const response = await fetch(`${FUNCTIONS_URL}/onboarding-register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, company_name }),
          });

          const result = await response.json();

          if (!response.ok) {
            showError(result.error || 'Registration failed. Please try again.');
            setLoading(false);
            return;
          }

          // Sign in the newly created user
          const { error: signInError } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (signInError) {
            showError('Account created but sign-in failed. Please go to the login page.');
            setLoading(false);
            return;
          }

          // Show success and redirect
          successAlert.classList.remove('hidden');
          errorAlert.classList.add('hidden');

          // Store the API key in a temporary alert for the user
          if (result.api_key) {
            console.log('API Key (save this!):', result.api_key);
          }

          setTimeout(() => {
            window.location.href = '/onboarding';
          }, 500);
        } catch (err) {
          showError('Network error. Please check your connection and try again.');
          setLoading(false);
        }
      });
    </script>
  </body>
</html>
